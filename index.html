<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pile Cap Design - Step by Step</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: #1a365d;
            color: white;
            padding: 24px 30px;
            text-align: center;
            border-bottom: 3px solid #2a69ac;
        }

        .header h1 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
            margin: 0;
        }

        /* Elevation Visualization Styles */
        .elevation-container {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            padding: 20px;
            text-align: center;
        }

        .elevation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .elevation-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .view-controls {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            background: #2a69ac;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: #1e5a96;
        }

        #plot3d {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .elevation-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #555;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }

        .phase-indicator {
            background: #34495e;
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .content {
            padding: 40px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .code-container {
            background: #2d3748;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .code-container::before {
            content: "Python";
            position: absolute;
            top: 10px;
            right: 15px;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .code {
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre;
        }

        .code .comment {
            color: #68d391;
        }

        .code .keyword {
            color: #9f7aea;
        }

        .code .string {
            color: #fbb6ce;
        }

        .code .number {
            color: #f6ad55;
        }

        .code .function {
            color: #63b3ed;
        }

        .description {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .description h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description p {
            color: #5a6c7d;
            margin-bottom: 10px;
        }

        .next-step {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }

        .next-step h3 {
            margin-bottom: 10px;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .parameter-category {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3498db;
        }

        .parameter-category h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .parameter {
            display: flex;
            flex-direction: column;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .parameter:last-child {
            border-bottom: none;
        }

        .parameter label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .parameter input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .parameter input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background: white;
        }

        .parameter input[type="text"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Load Cases Section Styles */
        .load-controls {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-file {
            background: #28a745;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-file:hover {
            background: #218838;
        }

        .btn-add {
            background: #17a2b8;
            color: white;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .paste-section {
            margin-top: 20px;
        }

        .paste-section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .paste-section textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        .table-container {
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }

        #loadCasesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        #loadCasesTable th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #loadCasesTable td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        #loadCasesTable input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
            font-size: 0.85rem;
        }

        #loadCasesTable input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.2);
        }

        #loadCasesTable tr:hover {
            background: #f8f9fa;
        }

        .data-summary {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
        }

        .data-summary h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        #summaryStats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #summaryStats span {
            color: #495057;
            font-size: 0.9rem;
        }

        #summaryStats strong {
            color: #2c3e50;
        }

        /* Analysis Section Styles */
        .analysis-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .results-section {
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .results-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }

        .prop-label {
            font-weight: 500;
            color: #495057;
        }

        .prop-value {
            font-weight: 600;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        #forceDistributionTable,
        #pileForceSummary {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        #forceDistributionTable th,
        #forceDistributionTable td,
        #pileForceSummary th,
        #pileForceSummary td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        #forceDistributionTable th,
        #pileForceSummary th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #forceDistributionTable tr:nth-child(even),
        #pileForceSummary tr:nth-child(even) {
            background: #f8f9fa;
        }

        #forceDistributionTable tr:hover,
        #pileForceSummary tr:hover {
            background: #e3f2fd;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card h5 {
            margin-bottom: 10px;
            font-size: 1rem;
            opacity: 0.9;
        }

        .summary-card p {
            margin-bottom: 5px;
        }

        .summary-card strong {
            font-size: 1.3rem;
            display: block;
            margin-bottom: 5px;
        }

        /* Enhanced Visualization Styles */
        #forceVisualization {
            position: relative;
            width: 100%;
            height: 700px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
            margin-top: 20px;
            overflow: hidden;
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }

        #forceCanvas {
            display: block;
            margin: 0 auto;
            cursor: crosshair;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #hoverTooltip {
            position: absolute;
            background: linear-gradient(145deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 400;
            pointer-events: none;
            display: none;
            z-index: 1000;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 280px;
        }

        #colorScale {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background: rgba(255,255,255,0.95);
            padding: 18px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 0 0 1px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.6);
            min-width: 150px;
        }

        /* Phase Headers and Content */
        .phase-header {
            background: #2a69ac;
            color: white;
            padding: 18px 24px;
            margin: 16px 0 0 0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #1e5a96;
        }

        .phase-header:hover {
            background: #1e5a96;
            border-color: #1a4f82;
        }

        .phase-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .toggle-arrow {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .phase-content {
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 24px;
            margin-bottom: 16px;
            display: none;
        }

        /* Phase 4 - Structural Design Calculations Styling */
        .calculation-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .calculation-section h3 {
            color: #2c3e50;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .formula-box {
            background: rgba(255,255,255,0.9);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .formula-box h4 {
            color: #2980b9;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .formula {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 14px;
            text-align: center;
            color: #2c3e50;
        }

        .parameter-explanation {
            background: rgba(52, 152, 219, 0.05);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-top: 15px;
        }

        .parameter-explanation p {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .parameter-explanation ul {
            margin: 0;
            padding-left: 20px;
        }

        .parameter-explanation li {
            margin: 5px 0;
            color: #495057;
            font-size: 13px;
        }

        .calc-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            margin: 15px 0;
        }

        .calc-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .results-section {
            background: rgba(39, 174, 96, 0.05);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-section h4 {
            color: #27ae60;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .result-item {
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .result-value {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 700;
            color: #e74c3c;
        }

        .safety-check {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }

        .safety-check.safe {
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .safety-check.unsafe {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .design-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .design-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .design-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .design-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .design-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        #visualizationLegend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 18px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 0 0 1px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.6);
        }

        .visualization-controls {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .viz-btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 12px 24px;
            margin: 0 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .viz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .viz-btn-primary {
            background: linear-gradient(145deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .viz-btn-secondary {
            background: linear-gradient(145deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .control-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                margin-bottom: 10px;
                text-align: center;
            }
            
            .table-wrapper {
                font-size: 0.8rem;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pile Cap Design</h1>
            <p>Structural Analysis - Step by Step Implementation</p>
        </div>
        
        <!-- 3D Interactive Visualization -->
        <div class="elevation-container">
            <div class="elevation-header">
                <h3>Interactive 3D Structure View</h3>
                <div class="view-controls">
                    <button onclick="resetView()" class="btn-small">Reset View</button>
                    <button onclick="topView()" class="btn-small">Top View</button>
                    <button onclick="sideView()" class="btn-small">Side View</button>
                </div>
            </div>
            <div id="plot3d" style="width:100%; height:500px;"></div>
            <div class="elevation-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #87CEEB;"></div>
                    <span>Water Level</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8B4513;"></div>
                    <span>Soil</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #C0C0C0;"></div>
                    <span>Concrete</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2F4F4F;"></div>
                    <span>Steel Column</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <span>Piles</span>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Phase 1: Design Parameters -->
            <div class="phase-header" onclick="togglePhase(1)">
                <h2>Step 1: Design Data Input & Pile Coordinate Generation</h2>
                <span class="toggle-arrow" id="arrow1">▼</span>
            </div>
            
            <div class="phase-content" id="phase1">
            <div class="parameter-grid">
                <div class="parameter-category">
                    <h4>Material Properties</h4>
                    <div class="parameter">
                        <label for="concrete_fc">Concrete Strength (f'c) - ksi:</label>
                        <input type="number" id="concrete_fc" value="5.5" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="steel_fy">Steel Strength (fy) - ksi:</label>
                        <input type="number" id="steel_fy" value="60" step="1">
                    </div>
                    <div class="parameter">
                        <label for="cover">Reinforcing Cover - in:</label>
                        <input type="number" id="cover" value="4.0" step="0.1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Column Dimensions</h4>
                    <div class="parameter">
                        <label for="column_x">Column X Dimension - ft:</label>
                        <input type="number" id="column_x" value="14.00" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="column_y">Column Y Dimension - ft:</label>
                        <input type="number" id="column_y" value="9.00" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="ecc_x">Eccentricity X - ft:</label>
                        <input type="number" id="ecc_x" value="0" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="ecc_y">Eccentricity Y - ft:</label>
                        <input type="number" id="ecc_y" value="0" step="0.01">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Footing Properties</h4>
                    <div class="parameter">
                        <label for="footing_thickness">Footing Thickness - ft:</label>
                        <input type="number" id="footing_thickness" value="9" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="pile_embedment">Pile Embedment - in:</label>
                        <input type="number" id="pile_embedment" value="12" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_overhang">Pile Overhang - in:</label>
                        <input type="number" id="pile_overhang" value="19.5" step="0.1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Site Conditions</h4>
                    <div class="parameter">
                        <label for="ground_elevation">Ground Elevation - ft:</label>
                        <input type="number" id="ground_elevation" value="73.4" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="footing_top_elevation">Footing Top Elevation - ft:</label>
                        <input type="number" id="footing_top_elevation" value="70.4" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="water_elevation">Water Elevation - ft:</label>
                        <input type="number" id="water_elevation" value="68.0" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="soil_weight">Soil Weight - ksf:</label>
                        <input type="number" id="soil_weight" value="0.115" step="0.001">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Pile Configuration</h4>
                    <div class="parameter">
                        <label for="pile_no_x">Number of Piles X:</label>
                        <input type="number" id="pile_no_x" value="8" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_no_y">Number of Piles Y:</label>
                        <input type="number" id="pile_no_y" value="6" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_spacing_x">X Spacing - ft:</label>
                        <input type="number" id="pile_spacing_x" value="4.15" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_spacing_y">Y Spacing - ft:</label>
                        <input type="number" id="pile_spacing_y" value="3.75" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_diameter">Pile Diameter - in:</label>
                        <input type="number" id="pile_diameter" value="15" step="1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Pile Capacity</h4>
                    <div class="parameter">
                        <label for="bearing_capacity">Bearing Capacity - tons:</label>
                        <input type="number" id="bearing_capacity" value="270" step="1">
                    </div>
                    <div class="parameter">
                        <label for="side_friction">Side Friction - tons:</label>
                        <input type="number" id="side_friction" value="270" step="1">
                    </div>
                    <div class="parameter">
                        <label for="compression_factor">Compression Factor:</label>
                        <input type="number" id="compression_factor" value="0.75" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="uplift_factor">Uplift Factor:</label>
                        <input type="number" id="uplift_factor" value="0.6" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_tip_elevation">Pile Tip Elevation - ft:</label>
                        <input type="number" id="pile_tip_elevation" value="34" step="1">
                    </div>
                    <div class="parameter">
                        <label for="boring">Boring Reference:</label>
                        <input type="text" id="boring" value="P41-1">
                    </div>
                </div>
            </div>

            <div class="next-step">
                <h3>Phase 1 Complete!</h3>
                <p>Design parameters established and pile coordinates generated successfully.</p>
                <p><strong>Moving to Phase 2:</strong> Load Cases Input Section</p>
            </div>
            </div>

            <!-- Phase 2: Load Cases -->
            <div class="phase-header" onclick="togglePhase(2)">
                <h2>Step 2: Load Cases Data Input</h2>
                <span class="toggle-arrow" id="arrow2">▼</span>
            </div>
            
            <div class="phase-content" id="phase2">
                <div class="load-controls">
                    <div class="control-buttons">
                        <button id="useDefaultData" class="btn btn-primary">Use Default Load Cases</button>
                        <button id="clearData" class="btn btn-secondary">Clear All Data</button>
                        <label for="fileInput" class="btn btn-file">
                            Import from File
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        </label>
                    </div>
                    
                    <div class="paste-section">
                        <h4>Paste from Excel/CSV:</h4>
                        <textarea id="pasteArea" placeholder="Paste your load cases data here (tab-separated or comma-separated)&#10;Format: LoadCase, Factor, Fx, Fy, Fz, Mx, My&#10;Example:&#10;1, 1.00, 230, 233, 6764, 10600, 12710&#10;2, 1.00, -230, 233, 4876, 10590, 10160"></textarea>
                        <button id="parseData" class="btn btn-primary">Parse Pasted Data</button>
                    </div>
                </div>

                <div class="table-container">
                    <h4>Current Load Cases:</h4>
                    <div class="table-wrapper">
                        <table id="loadCasesTable">
                            <thead>
                                <tr>
                                    <th>Load Case</th>
                                    <th>Factor</th>
                                    <th>Fx (k)</th>
                                    <th>Fy (k)</th>
                                    <th>Fz (k)</th>
                                    <th>Mx (k-ft)</th>
                                    <th>My (k-ft)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loadCasesBody">
                                <!-- Load cases will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="addRow" class="btn btn-add">Add New Row</button>
                </div>

                <div class="data-summary">
                    <h4>Data Summary:</h4>
                    <div id="summaryStats">
                        <span>Total Load Cases: <strong id="totalCases">0</strong></span>
                        <span>Max Fx: <strong id="maxFx">-</strong></span>
                        <span>Max Fy: <strong id="maxFy">-</strong></span>
                        <span>Max Fz: <strong id="maxFz">-</strong></span>
                    </div>
                </div>

                <div class="next-step" style="margin-top: 30px;">
                    <h3>Phase 2 Ready!</h3>
                    <p>Load cases configured successfully.</p>
                    <p><strong>Moving to Phase 3:</strong> Pile Force Distribution Analysis</p>
                </div>
            </div>

            <!-- Step 3: Force Distribution Analysis -->
            <div class="phase-header" onclick="togglePhase(3)">
                <h2>Step 3: Pile Force Distribution Analysis</h2>
                <span class="toggle-arrow" id="arrow3">▼</span>
            </div>
            
            <div class="phase-content" id="phase3">
                <div class="analysis-controls">
                    <button id="runAnalysis" class="btn btn-primary">Run Force Distribution Analysis</button>
                    <button id="downloadResults" class="btn btn-secondary" style="display: none;">Download Results</button>
                </div>

                <div id="analysisResults" style="display: none;">
                    <div class="results-section">
                        <h4>Pile Group Properties:</h4>
                        <div id="groupProperties" class="properties-grid">
                            <!-- Group properties will be populated here -->
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Force Distribution Table:</h4>
                        <div class="table-wrapper">
                            <table id="forceDistributionTable">
                                <thead id="forceTableHead">
                                    <!-- Headers will be populated dynamically -->
                                </thead>
                                <tbody id="forceTableBody">
                                    <!-- Force distribution data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Pile Force Summary:</h4>
                        <div class="table-wrapper">
                            <table id="pileForceSummary">
                                <thead>
                                    <tr>
                                        <th>Pile No.</th>
                                        <th>X (ft)</th>
                                        <th>Y (ft)</th>
                                        <th>Pmax (k)</th>
                                        <th>Max LC</th>
                                        <th>Pmin (k)</th>
                                        <th>Min LC</th>
                                    </tr>
                                </thead>
                                <tbody id="pileSummaryBody">
                                    <!-- Pile summary will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Analysis Summary:</h4>
                        <div id="analysisSummary" class="summary-cards">
                            <!-- Analysis summary will be populated here -->
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>🎯 Interactive Pile Force Distribution Visualization</h4>
                        <div class="description" style="margin-bottom: 20px;">
                            <p>This interactive visualization displays the pile force distribution in a top view with beautiful hover effects and zoom capabilities. Each pile is color-coded based on its maximum force value.</p>
                            <p><strong>Controls:</strong> Hover over piles for details, scroll to zoom, click and drag to pan, use Reset View to return to default.</p>
                        </div>
                        
                        <div id="forceVisualization">
                            <canvas id="forceCanvas" width="900" height="650"></canvas>
                            
                            <!-- Interactive Tooltip -->
                            <div id="hoverTooltip">
                                <div id="tooltipContent"></div>
                            </div>
                            
                            <!-- Enhanced Color Scale Legend -->
                            <div id="colorScale">
                                <div style="font-weight: 700; margin-bottom: 12px; color: #2c3e50; text-align: center; font-size: 13px;">
                                    Force Distribution
                                </div>
                                
                                <!-- Horizontal gradient bar -->
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 120px; height: 20px; background: linear-gradient(to right, #27ae60, #f1c40f, #e74c3c); border: 2px solid #bdc3c7; border-radius: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);"></div>
                                </div>
                                
                                <!-- Force value labels -->
                                <div style="display: flex; justify-content: space-between; width: 120px; font-size: 10px; font-weight: 600; margin-bottom: 8px;">
                                    <span id="minForceLabel" style="color: #27ae60;">Min</span>
                                    <span id="midForceLabel" style="color: #f39c12;">Mid</span>
                                    <span id="maxForceLabel" style="color: #e74c3c;">Max</span>
                                </div>
                                
                                <!-- Description labels -->
                                <div style="display: flex; justify-content: space-between; width: 120px; font-size: 9px; color: #7f8c8d;">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                                
                                <div style="text-align: center; margin-top: 10px; font-size: 10px; color: #6c757d; font-style: italic;">
                                    Force in kips
                                </div>
                            </div>
                            
                            <!-- Legend -->
                            <div id="visualizationLegend">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">Legend</div>
                                <div style="margin-bottom: 8px; display: flex; align-items: center;">
                                    <span style="color: #e74c3c; font-weight: bold; margin-right: 8px;">■</span>
                                    <span>Column</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; align-items: center;">
                                    <span style="color: #3498db; font-weight: bold; margin-right: 8px;">- -</span>
                                    <span>Footing</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; align-items: center;">
                                    <span style="color: #333; font-weight: bold; margin-right: 8px;">●</span>
                                    <span>Piles</span>
                                </div>
                                <div style="font-size: 11px; color: #7f8c8d; margin-top: 12px; font-style: italic;">
                                    Hover over piles for details
                                </div>
                            </div>
                        </div>
                        
                        <div class="visualization-controls">
                            <button onclick="updateVisualization()" class="viz-btn viz-btn-primary">
                                🔄 Update Visualization
                            </button>
                            <button onclick="resetVisualizationView()" class="viz-btn viz-btn-secondary">
                                🎯 Reset View
                            </button>
                            <button onclick="exportVisualization()" class="viz-btn viz-btn-secondary">
                                📥 Export Image
                            </button>
                        </div>
                    </div>
                </div>

                <div class="next-step" style="margin-top: 30px;">
                    <h3>Phase 3 Ready!</h3>
                    <p>Force distribution analysis complete.</p>
                    <p><strong>Next:</strong> Ready for Phase 4 - Structural Design Checks!</p>
                </div>
            </div>

            <!-- Step 4: Structural Design Calculations -->
            <div class="phase-header" onclick="togglePhase(4)">
                <h2>Step 4: Structural Design Calculations</h2>
                <span class="toggle-arrow" id="arrow4">▼</span>
            </div>
            
            <div class="phase-content" id="phase4">
                <!-- One-Way Shear Check Section -->
                <div class="calculation-section">
                    <h3>One-Way Shear Capacity Check</h3>
                    <div class="formula-box">
                        <h4>Shear Capacity Formulas (LRFD 5.8.3.3)</h4>
                        <div class="formula">
                            <strong>V<sub>c1</sub> = φ<sub>v</sub> × 0.0316 × β × √f'<sub>c</sub> × b<sub>w</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>c2</sub> = 0.25 × f'<sub>c</sub> × b<sub>w</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n</sub> = min(V<sub>c1</sub>, V<sub>c2</sub>)</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>φ<sub>v</sub> = 0.90 (strength reduction factor for shear)</li>
                                <li>β = 2.0 (per LRFD 5.8.3.4.1)</li>
                                <li>f'<sub>c</sub> = concrete compressive strength (ksi)</li>
                                <li>b<sub>w</sub> = footing width (ft)</li>
                                <li>d<sub>v</sub> = effective shear depth (ft)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateOneWayShear()" class="calc-button">
                        🧮 Calculate One-Way Shear Capacity
                    </button>
                    
                    <div id="oneWayShearResults" class="results-section" style="display: none;">
                        <h4>One-Way Shear Results</h4>
                        <div id="oneWayShearContent"></div>
                    </div>
                </div>

                <!-- Two-Way Shear (Punching Shear) Check Section -->
                <div class="calculation-section">
                    <h3>⚡ Two-Way Shear (Punching Shear) Check</h3>
                    <div class="formula-box">
                        <h4>Punching Shear Formulas (LRFD 5.13.3.6)</h4>
                        <div class="formula">
                            <strong>V<sub>n1</sub> = (0.063 + 0.126/β<sub>c</sub>) × √f'<sub>c</sub> × b<sub>0</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n2</sub> = 0.126 × √f'<sub>c</sub> × b<sub>0</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n</sub> = min(V<sub>n1</sub>, V<sub>n2</sub>)</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>β<sub>c</sub> = 2.0 (ratio of long side to short side of pile)</li>
                                <li>b<sub>0</sub> = perimeter of critical section (in)</li>
                                <li>φV<sub>n</sub> = φ × V<sub>n</sub> (design shear capacity)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateTwoWayShear()" class="calc-button">
                        🎯 Calculate Punching Shear Capacity
                    </button>
                    
                    <div id="twoWayShearResults" class="results-section" style="display: none;">
                        <h4>Two-Way Shear Results</h4>
                        <div id="twoWayShearContent"></div>
                    </div>
                </div>

                <!-- Flexural Design Section -->
                <div class="calculation-section">
                    <h3>Flexural Moment Design</h3>
                    <div class="formula-box">
                        <h4>Flexural Design Formulas</h4>
                        <div class="formula">
                            <strong>M<sub>u</sub> = P<sub>u</sub> × d<sub>crit</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>A<sub>s</sub> = 0.85 × (f'<sub>c</sub>/f<sub>y</sub>) × b × d × [1 - √(1 - 4M<sub>u</sub>/(1.7 × 0.9 × f'<sub>c</sub> × b × d²))]</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>M<sub>u</sub> = factored moment (kip-ft)</li>
                                <li>P<sub>u</sub> = factored pile load (kips)</li>
                                <li>d<sub>crit</sub> = critical section distance (ft)</li>
                                <li>A<sub>s</sub> = required steel area (in²)</li>
                                <li>f<sub>y</sub> = steel yield strength (ksi)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateFlexuralDesign()" class="calc-button">
                        Calculate Flexural Reinforcement
                    </button>
                    
                    <div id="flexuralResults" class="results-section" style="display: none;">
                        <h4>Flexural Design Results</h4>
                        <div id="flexuralContent"></div>
                    </div>
                </div>

                <!-- Design Summary Section -->
                <div class="calculation-section">
                    <h3>📋 Design Summary</h3>
                    <button onclick="generateDesignSummary()" class="calc-button">
                        📑 Generate Complete Design Summary
                    </button>
                    
                    <div id="designSummary" class="results-section" style="display: none;">
                        <h4>Complete Design Summary</h4>
                        <div id="designSummaryContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default load cases data
        const defaultLoadCases = [
            [1, 1.00, 230, 233, 6764, 10600, 12710],
            [2, 1.00, -230, 233, 4876, 10590, 10160],
            [3, 1.00, 0, 143, 8113, 6958, 1782],
            [4, 1.00, -217, 143, 4611, 6943, 15900],
            [5, 1.00, 125, -322, 4876, 14160, 6856],
            [6, 1.00, 125, 322, 6764, 14120, 7270],
            [7, 1.00, 125, 322, 4864, 14120, 6853],
            [8, 1.00, 125, -322, 6764, 14170, 7270],
            [9, 1.00, -25, 180, 7977, 8880, 15700]
        ];

        let loadCasesData = [];
        let pileCoordinates = [];
        let analysisResultsData = {};

        // Interactive 3D Visualization with Plotly
        function draw3DView() {
            // Get input values with defaults
            const waterElev = parseFloat(document.getElementById('water_elev')?.value || 95);
            const topFootingElev = parseFloat(document.getElementById('top_footing_elev')?.value || 90);
            const footingThick = parseFloat(document.getElementById('footing_thick')?.value || 4);
            const pileLength = parseFloat(document.getElementById('pile_length')?.value || 50);
            const columnWidth = parseFloat(document.getElementById('column_width')?.value || 3);
            const columnDepth = parseFloat(document.getElementById('column_depth')?.value || 3);
            const footingWidth = parseFloat(document.getElementById('footing_width')?.value || 15);
            const footingLength = parseFloat(document.getElementById('footing_length')?.value || 15);
            const numPilesX = parseInt(document.getElementById('piles_x')?.value || 3);
            const numPilesY = parseInt(document.getElementById('piles_y')?.value || 3);
            const spacingX = parseFloat(document.getElementById('spacing_x')?.value || 6);
            const spacingY = parseFloat(document.getElementById('spacing_y')?.value || 6);
            const pileDiameter = parseFloat(document.getElementById('pile_diameter')?.value || 1.5);
            
            // Calculate elevations
            const bottomFootingElev = topFootingElev - footingThick;
            const topPileElev = bottomFootingElev;
            const bottomPileElev = topPileElev - pileLength;
            
            const data = [];
            
            // Create pile coordinates
            const pileCoords = [];
            for (let i = 0; i < numPilesX; i++) {
                for (let j = 0; j < numPilesY; j++) {
                    const x = (i - (numPilesX - 1) / 2) * spacingX;
                    const y = (j - (numPilesY - 1) / 2) * spacingY;
                    pileCoords.push({ x, y });
                }
            }
            
            // Draw piles as cylinders
            pileCoords.forEach((pile, index) => {
                const pileRadius = pileDiameter / 2;
                const theta = [];
                const xPile = [];
                const yPile = [];
                const zTop = [];
                const zBottom = [];
                
                // Create cylinder coordinates
                for (let i = 0; i <= 20; i++) {
                    const angle = (i / 20) * 2 * Math.PI;
                    theta.push(angle);
                    xPile.push(pile.x + pileRadius * Math.cos(angle));
                    yPile.push(pile.y + pileRadius * Math.sin(angle));
                    zTop.push(topPileElev);
                    zBottom.push(bottomPileElev);
                }
                
                // Top circle of pile
                data.push({
                    x: xPile,
                    y: yPile,
                    z: zTop,
                    type: 'scatter3d',
                    mode: 'lines',
                    line: { color: '#FF6B6B', width: 4 },
                    name: `Pile ${index + 1} Top`,
                    showlegend: false,
                    hovertemplate: `Pile ${index + 1}<br>Top Elevation: ${topPileElev.toFixed(1)}'<extra></extra>`
                });
                
                // Bottom circle of pile
                data.push({
                    x: xPile,
                    y: yPile,
                    z: zBottom,
                    type: 'scatter3d',
                    mode: 'lines',
                    line: { color: '#FF6B6B', width: 4 },
                    name: `Pile ${index + 1} Bottom`,
                    showlegend: false,
                    hovertemplate: `Pile ${index + 1}<br>Bottom Elevation: ${bottomPileElev.toFixed(1)}'<extra></extra>`
                });
                
                // Vertical lines connecting top and bottom
                for (let i = 0; i < xPile.length; i += 5) {
                    data.push({
                        x: [xPile[i], xPile[i]],
                        y: [yPile[i], yPile[i]],
                        z: [topPileElev, bottomPileElev],
                        type: 'scatter3d',
                        mode: 'lines',
                        line: { color: '#FF6B6B', width: 2 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
            });
            
            // Draw pile cap/footing as a box
            const footingX = [-footingWidth/2, footingWidth/2, footingWidth/2, -footingWidth/2, -footingWidth/2];
            const footingY = [-footingLength/2, -footingLength/2, footingLength/2, footingLength/2, -footingLength/2];
            
            // Top of footing
            data.push({
                x: footingX,
                y: footingY,
                z: Array(5).fill(topFootingElev),
                type: 'scatter3d',
                mode: 'lines',
                line: { color: '#C0C0C0', width: 6 },
                name: 'Footing Top',
                showlegend: false,
                hovertemplate: `Pile Cap Top<br>Elevation: ${topFootingElev.toFixed(1)}'<br>Thickness: ${footingThick.toFixed(1)}'<extra></extra>`
            });
            
            // Bottom of footing
            data.push({
                x: footingX,
                y: footingY,
                z: Array(5).fill(bottomFootingElev),
                type: 'scatter3d',
                mode: 'lines',
                line: { color: '#A0A0A0', width: 6 },
                name: 'Footing Bottom',
                showlegend: false,
                hovertemplate: `Pile Cap Bottom<br>Elevation: ${bottomFootingElev.toFixed(1)}'<extra></extra>`
            });
            
            // Vertical edges of footing
            footingX.slice(0, 4).forEach((x, i) => {
                const y = footingY[i];
                data.push({
                    x: [x, x],
                    y: [y, y],
                    z: [bottomFootingElev, topFootingElev],
                    type: 'scatter3d',
                    mode: 'lines',
                    line: { color: '#B0B0B0', width: 4 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            });
            
            // Draw column
            const columnX = [-columnWidth/2, columnWidth/2, columnWidth/2, -columnWidth/2, -columnWidth/2];
            const columnY = [-columnDepth/2, -columnDepth/2, columnDepth/2, columnDepth/2, -columnDepth/2];
            
            data.push({
                x: columnX,
                y: columnY,
                z: Array(5).fill(topFootingElev),
                type: 'scatter3d',
                mode: 'lines',
                line: { color: '#2F4F4F', width: 8 },
                name: 'Column',
                showlegend: false,
                hovertemplate: `Column Base<br>Width: ${columnWidth.toFixed(1)}'<br>Depth: ${columnDepth.toFixed(1)}'<extra></extra>`
            });
            
            // Water level plane (if above bottom pile)
            if (waterElev > bottomPileElev) {
                const waterSize = Math.max(footingWidth, footingLength) * 1.5;
                const waterX = [-waterSize/2, waterSize/2, waterSize/2, -waterSize/2];
                const waterY = [-waterSize/2, -waterSize/2, waterSize/2, waterSize/2];
                
                data.push({
                    x: waterX,
                    y: waterY,
                    z: Array(4).fill(waterElev),
                    type: 'mesh3d',
                    opacity: 0.3,
                    color: '#87CEEB',
                    name: 'Water Level',
                    showlegend: false,
                    hovertemplate: `Water Level<br>Elevation: ${waterElev.toFixed(1)}'<extra></extra>`
                });
            }
            
            // Soil representation (simplified as boundary lines)
            const soilSize = Math.max(footingWidth, footingLength) * 2;
            const soilBoundary = [-soilSize/2, soilSize/2, soilSize/2, -soilSize/2, -soilSize/2];
            
            data.push({
                x: soilBoundary,
                y: soilBoundary,
                z: Array(5).fill(bottomPileElev - 5),
                type: 'scatter3d',
                mode: 'lines',
                line: { color: '#8B4513', width: 3 },
                name: 'Soil Boundary',
                showlegend: false,
                hovertemplate: `Soil Level<br>Elevation: ${(bottomPileElev - 5).toFixed(1)}'<extra></extra>`
            });
            
            // Layout configuration
            const layout = {
                scene: {
                    xaxis: {
                        title: 'X Distance (ft)',
                        showgrid: true,
                        gridcolor: '#E0E0E0'
                    },
                    yaxis: {
                        title: 'Y Distance (ft)',
                        showgrid: true,
                        gridcolor: '#E0E0E0'
                    },
                    zaxis: {
                        title: 'Elevation (ft)',
                        showgrid: true,
                        gridcolor: '#E0E0E0'
                    },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.2 },
                        center: { x: 0, y: 0, z: 0 }
                    },
                    bgcolor: '#F8F9FA',
                    aspectmode: 'manual',
                    aspectratio: { x: 1, y: 1, z: 0.7 }
                },
                margin: { l: 0, r: 0, b: 0, t: 30 },
                title: {
                    text: `Pile Cap 3D View - ${numPilesX}×${numPilesY} Piles @ ${spacingX}'×${spacingY}' O.C.`,
                    font: { size: 14, color: '#2c3e50' }
                },
                showlegend: false,
                hovermode: 'closest'
            };
            
            // Configuration
            const config = {
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
                displaylogo: false,
                responsive: true
            };
            
            // Create the plot
            Plotly.newPlot('plot3d', data, layout, config);
        }

        // View control functions
        function resetView() {
            const update = {
                'scene.camera.eye': { x: 1.5, y: 1.5, z: 1.2 },
                'scene.camera.center': { x: 0, y: 0, z: 0 }
            };
            Plotly.relayout('plot3d', update);
        }

        function topView() {
            const update = {
                'scene.camera.eye': { x: 0, y: 0, z: 2.5 },
                'scene.camera.center': { x: 0, y: 0, z: 0 }
            };
            Plotly.relayout('plot3d', update);
        }

        function sideView() {
            const update = {
                'scene.camera.eye': { x: 2.5, y: 0, z: 0 },
                'scene.camera.center': { x: 0, y: 0, z: 0 }
            };
            Plotly.relayout('plot3d', update);
        }

        // Function to update 3D view when inputs change
        function update3DView() {
            if (typeof Plotly !== 'undefined') {
                draw3DView();
            }
        }

        // Initialize 3D view on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(draw3DView, 500); // Delay to ensure Plotly is loaded
        });

        // Generate pile coordinates based on input parameters
        function generatePileCoordinates() {
            const pileNoX = parseInt(document.getElementById('pile_no_x').value);
            const pileNoY = parseInt(document.getElementById('pile_no_y').value);
            const spacingX = parseFloat(document.getElementById('pile_spacing_x').value);
            const spacingY = parseFloat(document.getElementById('pile_spacing_y').value);
            
            pileCoordinates = [];
            let pileNo = 1;
            
            for (let j = 0; j < pileNoY; j++) {
                for (let i = 0; i < pileNoX; i++) {
                    pileCoordinates.push({
                        'No.': pileNo++,
                        'x (ft)': i * spacingX - (pileNoX - 1) * spacingX / 2,
                        'y (ft)': j * spacingY - (pileNoY - 1) * spacingY / 2
                    });
                }
            }
            
            return pileCoordinates;
        }

        // Get design parameters from input fields
        function getDesignParameters() {
            return {
                pile_spacing_x_ft: parseFloat(document.getElementById('pile_spacing_x').value),
                pile_spacing_y_ft: parseFloat(document.getElementById('pile_spacing_y').value),
                pile_no_x: parseInt(document.getElementById('pile_no_x').value),
                pile_no_y: parseInt(document.getElementById('pile_no_y').value),
                pile_overhang_in: parseFloat(document.getElementById('pile_overhang').value),
                footing_thickness_ft: parseFloat(document.getElementById('footing_thickness').value),
                column_x_dim_ft: parseFloat(document.getElementById('column_x').value),
                column_y_dim_ft: parseFloat(document.getElementById('column_y').value),
                column_ecc_x_ft: parseFloat(document.getElementById('ecc_x').value),
                column_ecc_y_ft: parseFloat(document.getElementById('ecc_y').value),
                soil_weight_ksf: parseFloat(document.getElementById('soil_weight').value),
                ground_elevation_ft: parseFloat(document.getElementById('ground_elevation').value),
                footing_top_elevation_ft: parseFloat(document.getElementById('footing_top_elevation').value),
                water_elevation_ft: parseFloat(document.getElementById('water_elevation').value),
                pile_embedment_in: parseFloat(document.getElementById('pile_embedment').value),
                seal_thickness_ft: 0.0 // Default value
            };
        }

        // Run force distribution analysis
        function runForceDistributionAnalysis() {
            if (loadCasesData.length === 0) {
                alert('Please configure load cases first.');
                return;
            }

            // Generate pile coordinates
            const coords = generatePileCoordinates();
            const params = getDesignParameters();
            
            // Calculate pile group properties
            const n_piles = coords.length;
            const Pcx = coords.reduce((sum, p) => sum + p['x (ft)'], 0) / n_piles;
            const Pcy = coords.reduce((sum, p) => sum + p['y (ft)'], 0) / n_piles;
            
            const ix = coords.reduce((sum, p) => sum + Math.pow(p['y (ft)'] - Pcx, 2), 0);
            const iy = coords.reduce((sum, p) => sum + Math.pow(p['x (ft)'] - Pcy, 2), 0);
            
            const footing_length = params.pile_spacing_x_ft * (params.pile_no_x - 1) + 2 * params.pile_overhang_in / 12;
            const footing_width = params.pile_spacing_y_ft * (params.pile_no_y - 1) + 2 * params.pile_overhang_in / 12;
            
            const CCx = footing_length / 2 + params.column_ecc_x_ft;
            const CCy = footing_width / 2 + params.column_ecc_y_ft;
            const Fcx = footing_length / 2;
            const Fcy = footing_width / 2;
            
            // Calculate weights
            const wt_foot = 0.15 * footing_length * footing_width * params.footing_thickness_ft;
            const wt_soil = (footing_length * footing_width - params.column_x_dim_ft * params.column_y_dim_ft) * 
                           params.soil_weight_ksf * Math.max(params.ground_elevation_ft - params.footing_top_elevation_ft, 0);
            const wt_water = Math.max(Math.min(params.water_elevation_ft, Math.max(params.ground_elevation_ft, params.footing_top_elevation_ft))
                           - (params.footing_top_elevation_ft - params.footing_thickness_ft - 0), 0) * 0.0624 * footing_length * footing_width;
            
            // Process each load case
            const forcesData = [];
            
            loadCasesData.forEach(loadCase => {
                const dc = loadCase[1]; // Factor
                const fx = loadCase[2];
                const fy = loadCase[3];
                const fz_original = loadCase[4];
                const mx_original = loadCase[5];
                const my_original = loadCase[6];
                
                // Weight term
                const weight_term = dc <= 1 ? 
                    (wt_foot - wt_water + wt_soil) : 
                    (wt_foot + wt_soil * 1.35 / 1.25);
                
                // Calculate corrected forces and moments
                const fz = fz_original + weight_term * dc;
                
                const mx = mx_original + 
                          fy * (params.footing_thickness_ft - params.pile_embedment_in / 12) +
                          fz_original * (CCy - Pcy) +
                          weight_term * dc * (Fcy - Pcy);
                
                const my = my_original +
                          fx * (params.footing_thickness_ft - params.pile_embedment_in / 12) +
                          fz_original * (Pcx - CCx) +
                          weight_term * dc * (Pcx - Fcx);
                
                // Create row data
                const row = {
                    LC: loadCase[0],
                    DC: dc,
                    P: Math.round(fz * 100) / 100,
                    Mx: Math.round(mx * 100) / 100,
                    My: Math.round(my * 100) / 100
                };
                
                // Distribute forces to each pile
                coords.forEach((pile, index) => {
                    const pile_x = pile['x (ft)'];
                    const pile_y = pile['y (ft)'];
                    
                    const paxial = fz / n_piles;
                    const pmy = ix !== 0 ? my * (pile_x - Pcx) / ix : 0;
                    const pmx = iy !== 0 ? mx * (pile_y - Pcy) / iy : 0;
                    const total_p = paxial + pmx + pmy;
                    
                    row[`P${index + 1}`] = Math.round(total_p * 100) / 100;
                });
                
                forcesData.push(row);
            });
            
            // Calculate pile force summary
            const pileSummary = coords.map((pile, index) => {
                const forces = forcesData.map(row => row[`P${index + 1}`]);
                const maxForce = Math.max(...forces);
                const minForce = Math.min(...forces);
                const maxLC = forcesData[forces.indexOf(maxForce)].LC;
                const minLC = forcesData[forces.indexOf(minForce)].LC;
                
                return {
                    pileNo: pile['No.'],
                    x: pile['x (ft)'],
                    y: pile['y (ft)'],
                    pmax: Math.round(maxForce * 100) / 100,
                    maxLC: maxLC,
                    pmin: Math.round(minForce * 100) / 100,
                    minLC: minLC
                };
            });
            
            // Store results
            analysisResultsData = {
                groupProperties: {
                    nPiles: n_piles,
                    Pcx: Math.round(Pcx * 100) / 100,
                    Pcy: Math.round(Pcy * 100) / 100,
                    ix: Math.round(ix * 100) / 100,
                    iy: Math.round(iy * 100) / 100,
                    footingLength: Math.round(footing_length * 100) / 100,
                    footingWidth: Math.round(footing_width * 100) / 100,
                    wtFoot: Math.round(wt_foot * 100) / 100,
                    wtSoil: Math.round(wt_soil * 100) / 100,
                    wtWater: Math.round(wt_water * 100) / 100
                },
                forcesData: forcesData,
                pileSummary: pileSummary,
                coordinates: coords
            };
            
            // Display results
            displayAnalysisResults();
        }

        // Display analysis results
        function displayAnalysisResults() {
            const results = analysisResultsData;
            
            // Show results section
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('downloadResults').style.display = 'inline-block';
            
            // Display group properties
            const groupProps = document.getElementById('groupProperties');
            groupProps.innerHTML = `
                <div class="property-item">
                    <span class="prop-label">Number of Piles:</span>
                    <span class="prop-value">${results.groupProperties.nPiles}</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Pile Centroid X (Pcx):</span>
                    <span class="prop-value">${results.groupProperties.Pcx} ft</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Pile Centroid Y (Pcy):</span>
                    <span class="prop-value">${results.groupProperties.Pcy} ft</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Moment of Inertia (Ix):</span>
                    <span class="prop-value">${results.groupProperties.ix} ft⁴</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Moment of Inertia (Iy):</span>
                    <span class="prop-value">${results.groupProperties.iy} ft⁴</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Footing Length:</span>
                    <span class="prop-value">${results.groupProperties.footingLength} ft</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Footing Width:</span>
                    <span class="prop-value">${results.groupProperties.footingWidth} ft</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Footing Weight:</span>
                    <span class="prop-value">${results.groupProperties.wtFoot} kips</span>
                </div>
                <div class="property-item">
                    <span class="prop-label">Soil Weight:</span>
                    <span class="prop-value">${results.groupProperties.wtSoil} kips</span>
                </div>
            `;
            
            // Display force distribution table
            displayForceDistributionTable();
            
            // Display pile summary
            displayPileSummary();
            
            // Display analysis summary
            displayAnalysisSummary();
            
            // Update visualization
            setTimeout(updateVisualization, 100); // Small delay to ensure canvas is ready
        }

        // Display force distribution table
        function displayForceDistributionTable() {
            const results = analysisResultsData;
            const thead = document.getElementById('forceTableHead');
            const tbody = document.getElementById('forceTableBody');
            
            // Create headers
            let headers = '<tr><th>LC</th><th>DC</th><th>P (kips)</th><th>Mx (k-ft)</th><th>My (k-ft)</th>';
            for (let i = 1; i <= results.groupProperties.nPiles; i++) {
                headers += `<th>P${i} (k)</th>`;
            }
            headers += '</tr>';
            thead.innerHTML = headers;
            
            // Create rows
            let rows = '';
            results.forcesData.forEach(row => {
                let rowHtml = `<tr>
                    <td>${row.LC}</td>
                    <td>${row.DC}</td>
                    <td>${row.P}</td>
                    <td>${row.Mx}</td>
                    <td>${row.My}</td>`;
                
                for (let i = 1; i <= results.groupProperties.nPiles; i++) {
                    rowHtml += `<td>${row[`P${i}`]}</td>`;
                }
                rowHtml += '</tr>';
                rows += rowHtml;
            });
            tbody.innerHTML = rows;
        }

        // Display pile summary
        function displayPileSummary() {
            const results = analysisResultsData;
            const tbody = document.getElementById('pileSummaryBody');
            
            let rows = '';
            results.pileSummary.forEach(pile => {
                rows += `<tr>
                    <td>${pile.pileNo}</td>
                    <td>${pile.x}</td>
                    <td>${pile.y}</td>
                    <td>${pile.pmax}</td>
                    <td>${pile.maxLC}</td>
                    <td>${pile.pmin}</td>
                    <td>${pile.minLC}</td>
                </tr>`;
            });
            tbody.innerHTML = rows;
        }

        // Display analysis summary
        function displayAnalysisSummary() {
            const results = analysisResultsData;
            const maxPile = results.pileSummary.reduce((max, pile) => pile.pmax > max.pmax ? pile : max);
            const minPile = results.pileSummary.reduce((min, pile) => pile.pmin < min.pmin ? pile : min);
            const totalCases = results.forcesData.length;
            
            document.getElementById('analysisSummary').innerHTML = `
                <div class="summary-card">
                    <h5>Maximum Pile Force</h5>
                    <p><strong>${maxPile.pmax} kips</strong></p>
                    <p>Pile ${maxPile.pileNo} (LC ${maxPile.maxLC})</p>
                </div>
                <div class="summary-card">
                    <h5>Minimum Pile Force</h5>
                    <p><strong>${minPile.pmin} kips</strong></p>
                    <p>Pile ${minPile.pileNo} (LC ${minPile.minLC})</p>
                </div>
                <div class="summary-card">
                    <h5>Load Cases Analyzed</h5>
                    <p><strong>${totalCases} cases</strong></p>
                    <p>All combinations processed</p>
                </div>
                <div class="summary-card">
                    <h5>Pile Configuration</h5>
                    <p><strong>${results.groupProperties.nPiles} piles</strong></p>
                    <p>${document.getElementById('pile_no_x').value} × ${document.getElementById('pile_no_y').value} layout</p>
                </div>
            `;
        }

        // Initialize with default data
        function loadDefaultData() {
            loadCasesData = defaultLoadCases.map(row => [...row]);
            renderTable();
            updateSummary();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('loadCasesBody');
            tbody.innerHTML = '';
            
            loadCasesData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = 
                    '<td><input type="number" value="' + row[0] + '" onchange="updateCell(' + index + ', 0, this.value)"></td>' +
                    '<td><input type="number" step="0.01" value="' + row[1] + '" onchange="updateCell(' + index + ', 1, this.value)"></td>' +
                    '<td><input type="number" value="' + row[2] + '" onchange="updateCell(' + index + ', 2, this.value)"></td>' +
                    '<td><input type="number" value="' + row[3] + '" onchange="updateCell(' + index + ', 3, this.value)"></td>' +
                    '<td><input type="number" value="' + row[4] + '" onchange="updateCell(' + index + ', 4, this.value)"></td>' +
                    '<td><input type="number" value="' + row[5] + '" onchange="updateCell(' + index + ', 5, this.value)"></td>' +
                    '<td><input type="number" value="' + row[6] + '" onchange="updateCell(' + index + ', 6, this.value)"></td>' +
                    '<td><button class="btn-delete" onclick="deleteRow(' + index + ')">Delete</button></td>';
                tbody.appendChild(tr);
            });
        }

        // Update cell value
        function updateCell(rowIndex, colIndex, value) {
            loadCasesData[rowIndex][colIndex] = parseFloat(value) || 0;
            updateSummary();
        }

        // Delete row
        function deleteRow(index) {
            loadCasesData.splice(index, 1);
            renderTable();
            updateSummary();
        }

        // Add new row
        function addNewRow() {
            const newRowNum = loadCasesData.length + 1;
            loadCasesData.push([newRowNum, 1.00, 0, 0, 0, 0, 0]);
            renderTable();
            updateSummary();
        }

        // Update summary statistics
        function updateSummary() {
            document.getElementById('totalCases').textContent = loadCasesData.length;
            
            if (loadCasesData.length > 0) {
                const maxFx = Math.max(...loadCasesData.map(row => Math.abs(row[2])));
                const maxFy = Math.max(...loadCasesData.map(row => Math.abs(row[3])));
                const maxFz = Math.max(...loadCasesData.map(row => Math.abs(row[4])));
                
                document.getElementById('maxFx').textContent = maxFx.toFixed(0) + ' k';
                document.getElementById('maxFy').textContent = maxFy.toFixed(0) + ' k';
                document.getElementById('maxFz').textContent = maxFz.toFixed(0) + ' k';
            } else {
                document.getElementById('maxFx').textContent = '-';
                document.getElementById('maxFy').textContent = '-';
                document.getElementById('maxFz').textContent = '-';
            }
        }

        // Parse pasted data
        function parsePastedData() {
            const pasteArea = document.getElementById('pasteArea');
            const text = pasteArea.value.trim();
            
            if (!text) {
                alert('Please paste some data first.');
                return;
            }

            try {
                const lines = text.split('\n');
                const newData = [];
                
                lines.forEach(line => {
                    if (line.trim()) {
                        // Handle both comma and tab separation
                        const values = line.split(/[,\t]/).map(v => parseFloat(v.trim()));
                        if (values.length >= 7 && values.every(v => !isNaN(v))) {
                            newData.push(values.slice(0, 7));
                        }
                    }
                });

                if (newData.length > 0) {
                    loadCasesData = newData;
                    renderTable();
                    updateSummary();
                    pasteArea.value = '';
                    alert(`Successfully imported ${newData.length} load cases.`);
                } else {
                    alert('No valid data found. Please check the format.');
                }
            } catch (error) {
                alert('Error parsing data. Please check the format.');
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all load cases?')) {
                loadCasesData = [];
                renderTable();
                updateSummary();
            }
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    document.getElementById('pasteArea').value = text;
                    alert('File content loaded. Click "Parse Pasted Data" to import.');
                };
                reader.readAsText(file);
            }
        });

        // Enhanced interactive visualization with hover effects
        let visualizationData = null;
        let currentScale = 1;
        let currentOffsetX = 0;
        let currentOffsetY = 0;

        function updateVisualization() {
            if (!analysisResultsData.pileSummary || analysisResultsData.pileSummary.length === 0) {
                alert('Please run the analysis first to generate visualization data.');
                return;
            }

            const canvas = document.getElementById('forceCanvas');
            const ctx = canvas.getContext('2d');
            
            // Get parameters
            const params = getDesignParameters();
            const pileSummary = analysisResultsData.pileSummary;
            
            // Calculate pile center (equivalent to pile_center_x, pile_center_y)
            const pile_center_x = pileSummary.reduce((sum, p) => sum + p.x, 0) / pileSummary.length;
            const pile_center_y = pileSummary.reduce((sum, p) => sum + p.y, 0) / pileSummary.length;
            
            // Get footing dimensions
            const footing_x_dim = analysisResultsData.groupProperties.footingLength;
            const footing_y_dim = analysisResultsData.groupProperties.footingWidth;
            
            // Canvas dimensions and scaling
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const margin = 80;
            
            // Find data bounds
            const xCoords = pileSummary.map(p => p.x);
            const yCoords = pileSummary.map(p => p.y);
            const minX = Math.min(...xCoords, pile_center_x - footing_x_dim/2);
            const maxX = Math.max(...xCoords, pile_center_x + footing_x_dim/2);
            const minY = Math.min(...yCoords, pile_center_y - footing_y_dim/2);
            const maxY = Math.max(...yCoords, pile_center_y + footing_y_dim/2);
            
            const rangeX = maxX - minX;
            const rangeY = maxY - minY;
            const maxRange = Math.max(rangeX, rangeY);
            
            // Calculate scale to fit canvas with margin
            const baseScale = Math.min((canvasWidth - 2*margin) / maxRange, (canvasHeight - 2*margin) / maxRange);
            const scale = baseScale * currentScale;
            
            // Helper function to convert coordinates
            function toCanvas(x, y) {
                const centerX = canvasWidth / 2 + currentOffsetX;
                const centerY = canvasHeight / 2 + currentOffsetY;
                return {
                    x: centerX + (x - pile_center_x) * scale,
                    y: centerY - (y - pile_center_y) * scale  // Flip Y axis
                };
            }
            
            // Store visualization data for interaction
            visualizationData = {
                pileSummary,
                pile_center_x,
                pile_center_y,
                footing_x_dim,
                footing_y_dim,
                params,
                toCanvas,
                scale
            };
            
            // Clear canvas with beautiful gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvasWidth, canvasHeight);
            gradient.addColorStop(0, '#f8f9fa');
            gradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // Draw subtle grid
            drawEnhancedGrid(ctx, canvasWidth, canvasHeight, scale);
            
            // Draw footing outline (enhanced dashed blue rectangle)
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 8]);
            ctx.shadowColor = 'rgba(52, 152, 219, 0.3)';
            ctx.shadowBlur = 4;
            
            const footingCorners = [
                toCanvas(pile_center_x - footing_x_dim/2, pile_center_y - footing_y_dim/2),
                toCanvas(pile_center_x + footing_x_dim/2, pile_center_y - footing_y_dim/2),
                toCanvas(pile_center_x + footing_x_dim/2, pile_center_y + footing_y_dim/2),
                toCanvas(pile_center_x - footing_x_dim/2, pile_center_y + footing_y_dim/2)
            ];
            
            ctx.beginPath();
            ctx.moveTo(footingCorners[0].x, footingCorners[0].y);
            footingCorners.forEach(corner => ctx.lineTo(corner.x, corner.y));
            ctx.closePath();
            ctx.stroke();
            
            // Draw column outline (enhanced solid red rectangle)
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 4;
            ctx.setLineDash([]);
            ctx.shadowColor = 'rgba(231, 76, 60, 0.4)';
            ctx.shadowBlur = 6;
            
            const columnCorners = [
                toCanvas(pile_center_x - params.column_x_dim_ft/2, pile_center_y - params.column_y_dim_ft/2),
                toCanvas(pile_center_x + params.column_x_dim_ft/2, pile_center_y - params.column_y_dim_ft/2),
                toCanvas(pile_center_x + params.column_x_dim_ft/2, pile_center_y + params.column_y_dim_ft/2),
                toCanvas(pile_center_x - params.column_x_dim_ft/2, pile_center_y + params.column_y_dim_ft/2)
            ];
            
            ctx.beginPath();
            ctx.moveTo(columnCorners[0].x, columnCorners[0].y);
            columnCorners.forEach(corner => ctx.lineTo(corner.x, corner.y));
            ctx.closePath();
            ctx.stroke();
            
            // Find min/max forces for color scaling
            const forces = pileSummary.map(p => p.pmax);
            const minForce = Math.min(...forces);
            const maxForce = Math.max(...forces);
            const forceRange = maxForce - minForce;
            
            // Update color scale legend
            updateColorScaleLegend(minForce, maxForce);
            
            // Draw piles with enhanced styling
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            
            pileSummary.forEach(pile => {
                const pos = toCanvas(pile.x, pile.y);
                
                // Color based on force (green to red scale via yellow)
                const normalizedForce = forceRange > 0 ? (pile.pmax - minForce) / forceRange : 0;
                const color = getEnhancedForceColor(normalizedForce);
                
                // Draw pile circle with enhanced 3D effect
                const radius = Math.max(8, scale * 0.4);
                
                // Outer shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.arc(pos.x + 2, pos.y + 2, radius, 0, 2 * Math.PI);
                ctx.fill();
                
                // Outer glow
                const glowGradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, radius + 4);
                glowGradient.addColorStop(0, color.glow);
                glowGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius + 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Main circle with gradient
                const mainGradient = ctx.createRadialGradient(pos.x - radius/3, pos.y - radius/3, 0, pos.x, pos.y, radius);
                mainGradient.addColorStop(0, color.highlight);
                mainGradient.addColorStop(0.7, color.main);
                mainGradient.addColorStop(1, color.shadow);
                
                ctx.fillStyle = mainGradient;
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.setLineDash([]);
                
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // Inner highlight
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.beginPath();
                ctx.arc(pos.x - radius/3, pos.y - radius/3, radius/4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Note: Pile labels and force values are now hidden
                // They will only appear in the interactive tooltip on hover
            });
            
            // Add enhanced title
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 20px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            const title = 'Interactive Pile Force Distribution (Top View)';
            ctx.strokeText(title, canvasWidth/2, 35);
            ctx.fillText(title, canvasWidth/2, 35);
            
            // Add axis labels with enhanced styling
            ctx.font = '14px Inter, sans-serif';
            ctx.fillStyle = '#495057';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            
            const xLabel = 'X Distance (ft)';
            ctx.strokeText(xLabel, canvasWidth/2, canvasHeight - 15);
            ctx.fillText(xLabel, canvasWidth/2, canvasHeight - 15);
            
            ctx.save();
            ctx.translate(20, canvasHeight/2);
            ctx.rotate(-Math.PI/2);
            const yLabel = 'Y Distance (ft)';
            ctx.strokeText(yLabel, 0, 0);
            ctx.fillText(yLabel, 0, 0);
            ctx.restore();
            
            // Add coordinate system indicator
            drawEnhancedCoordinateSystem(ctx, canvasWidth, canvasHeight);
        }

        // Enhanced helper function to get force-based colors
        function getEnhancedForceColor(normalizedForce) {
            let r, g, b;
            
            if (normalizedForce < 0.5) {
                // Green to Yellow
                r = Math.round(255 * normalizedForce * 2);
                g = 255;
                b = 0;
            } else {
                // Yellow to Red
                r = 255;
                g = Math.round(255 * (1 - (normalizedForce - 0.5) * 2));
                b = 0;
            }
            
            return {
                main: `rgb(${r}, ${g}, ${b})`,
                glow: `rgba(${r}, ${g}, ${b}, 0.4)`,
                highlight: `rgba(${Math.min(255, r + 60)}, ${Math.min(255, g + 60)}, ${Math.min(255, b + 60)}, 0.9)`,
                shadow: `rgba(${Math.max(0, r - 40)}, ${Math.max(0, g - 40)}, ${Math.max(0, b - 40)}, 1)`
            };
        }

        // Enhanced coordinate system
        function drawEnhancedCoordinateSystem(ctx, width, height) {
            const x = width - 100;
            const y = height - 100;
            const size = 40;
            
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            
            // X axis
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + size, y);
            ctx.stroke();
            
            // Y axis
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y - size);
            ctx.stroke();
            
            // Enhanced arrowheads
            ctx.fillStyle = '#7f8c8d';
            ctx.beginPath();
            ctx.moveTo(x + size - 8, y - 4);
            ctx.lineTo(x + size, y);
            ctx.lineTo(x + size - 8, y + 4);
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(x - 4, y - size + 8);
            ctx.lineTo(x, y - size);
            ctx.lineTo(x + 4, y - size + 8);
            ctx.fill();
            
            // Enhanced labels
            ctx.fillStyle = '#495057';
            ctx.font = 'bold 12px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('X', x + size + 12, y + 4);
            ctx.fillText('Y', x, y - size - 12);
        }

        // Enhanced grid
        function drawEnhancedGrid(ctx, width, height, scale) {
            if (scale < 0.4) return; // Don't draw grid when zoomed out too much
            
            ctx.strokeStyle = 'rgba(200, 200, 200, 0.2)';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 4]);
            
            const gridSize = 25 * scale;
            const offsetX = currentOffsetX % gridSize;
            const offsetY = currentOffsetY % gridSize;
            
            // Vertical lines
            for (let x = offsetX; x < width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = offsetY; y < height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
        }

        // Export visualization function
        function exportVisualization() {
            if (!visualizationData) {
                alert('Please run the analysis and update visualization first.');
                return;
            }
            
            const canvas = document.getElementById('forceCanvas');
            const link = document.createElement('a');
            link.download = 'pile_force_distribution.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Enhanced update color scale legend
        function updateColorScaleLegend(minForce, maxForce) {
            document.getElementById('maxForceLabel').textContent = `${maxForce.toFixed(0)}k`;
            document.getElementById('midForceLabel').textContent = `${((minForce + maxForce)/2).toFixed(0)}k`;
            document.getElementById('minForceLabel').textContent = `${minForce.toFixed(0)}k`;
            
            // Add enhanced styling to legend labels
            const labels = ['maxForceLabel', 'midForceLabel', 'minForceLabel'];
            labels.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.style.fontFamily = 'Inter, sans-serif';
                    elem.style.fontWeight = '600';
                    elem.style.fontSize = '11px';
                    elem.style.color = '#2c3e50';
                    elem.style.textShadow = '0 1px 2px rgba(255,255,255,0.8)';
                }
            });
        }

        // Mouse interaction handlers
        function setupCanvasInteraction() {
            const canvas = document.getElementById('forceCanvas');
            const tooltip = document.getElementById('hoverTooltip');
            let isDragging = false;
            let lastMouseX = 0;
            let lastMouseY = 0;

            canvas.addEventListener('mousemove', function(e) {
                if (!visualizationData) return;
                
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                if (isDragging) {
                    const deltaX = mouseX - lastMouseX;
                    const deltaY = mouseY - lastMouseY;
                    currentOffsetX += deltaX;
                    currentOffsetY += deltaY;
                    updateVisualization();
                    lastMouseX = mouseX;
                    lastMouseY = mouseY;
                    return;
                }
                
                // Check for pile hover
                const hoveredPile = findPileAtPosition(mouseX, mouseY);
                
                if (hoveredPile) {
                    showTooltip(e, hoveredPile);
                    canvas.style.cursor = 'pointer';
                } else {
                    hideTooltip();
                    canvas.style.cursor = 'crosshair';
                }
            });

            canvas.addEventListener('mousedown', function(e) {
                const rect = canvas.getBoundingClientRect();
                lastMouseX = e.clientX - rect.left;
                lastMouseY = e.clientY - rect.top;
                isDragging = true;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mouseup', function() {
                isDragging = false;
                canvas.style.cursor = 'crosshair';
            });

            canvas.addEventListener('mouseleave', function() {
                hideTooltip();
                isDragging = false;
                canvas.style.cursor = 'crosshair';
            });

            // Zoom with mouse wheel
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                currentScale *= zoomFactor;
                currentScale = Math.max(0.1, Math.min(5, currentScale)); // Limit zoom
                updateVisualization();
            });
        }

        // Find pile at mouse position
        function findPileAtPosition(mouseX, mouseY) {
            if (!visualizationData) return null;
            
            const { pileSummary, toCanvas, scale } = visualizationData;
            const radius = Math.max(6, scale * 0.3) + 5; // Add some tolerance
            
            for (const pile of pileSummary) {
                const pos = toCanvas(pile.x, pile.y);
                const distance = Math.sqrt(Math.pow(mouseX - pos.x, 2) + Math.pow(mouseY - pos.y, 2));
                
                if (distance <= radius) {
                    return pile;
                }
            }
            
            return null;
        }

        // Enhanced show tooltip with beautiful styling
        function showTooltip(e, pile) {
            const tooltip = document.getElementById('hoverTooltip');
            const content = document.getElementById('tooltipContent');
            
            content.innerHTML = `
                <div style="font-family: 'Inter', sans-serif; font-weight: 700; margin-bottom: 12px; color: #3498db; font-size: 14px; text-align: center; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                    Pile #${pile.pileNo}
                </div>
                <div style="font-family: 'Inter', sans-serif; margin-bottom: 6px; display: flex; justify-content: space-between;">
                    <span style="color: #6c757d; font-weight: 500;">📍 Position:</span> 
                    <span style="font-weight: 600; color: #2c3e50;">(${pile.x.toFixed(2)}, ${pile.y.toFixed(2)}) ft</span>
                </div>
                <div style="font-family: 'Inter', sans-serif; margin-bottom: 6px; display: flex; justify-content: space-between;">
                    <span style="color: #6c757d; font-weight: 500;">⬆️ Max Force:</span> 
                    <span style="font-weight: 700; color: #e74c3c; background: rgba(231, 76, 60, 0.1); padding: 2px 6px; border-radius: 4px;">${pile.pmax.toFixed(1)} kips</span>
                </div>
                <div style="font-family: 'Inter', sans-serif; margin-bottom: 6px; display: flex; justify-content: space-between;">
                    <span style="color: #6c757d; font-weight: 500;">📋 Max LC:</span> 
                    <span style="font-weight: 600; color: #2c3e50;">LC ${pile.maxLC}</span>
                </div>
                <div style="font-family: 'Inter', sans-serif; margin-bottom: 6px; display: flex; justify-content: space-between;">
                    <span style="color: #6c757d; font-weight: 500;">⬇️ Min Force:</span> 
                    <span style="font-weight: 700; color: #27ae60; background: rgba(39, 174, 96, 0.1); padding: 2px 6px; border-radius: 4px;">${pile.pmin.toFixed(1)} kips</span>
                </div>
                <div style="font-family: 'Inter', sans-serif; display: flex; justify-content: space-between;">
                    <span style="color: #6c757d; font-weight: 500;">📋 Min LC:</span> 
                    <span style="font-weight: 600; color: #2c3e50;">LC ${pile.minLC}</span>
                </div>
            `;
            
            // Enhanced positioning with boundary checks
            const tooltipWidth = 280;
            const tooltipHeight = 200;
            let left = e.clientX + 15;
            let top = e.clientY - 10;
            
            // Check right boundary
            if (left + tooltipWidth > window.innerWidth) {
                left = e.clientX - tooltipWidth - 15;
            }
            
            // Check bottom boundary
            if (top + tooltipHeight > window.innerHeight) {
                top = e.clientY - tooltipHeight + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.display = 'block';
            
            // Add subtle entrance animation
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'scale(0.9)';
            setTimeout(() => {
                tooltip.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'scale(1)';
            }, 10);
        }

        // Enhanced hide tooltip with animation
        function hideTooltip() {
            const tooltip = document.getElementById('hoverTooltip');
            tooltip.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'scale(0.9)';
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 150);
        }

        // Reset view
        function resetVisualizationView() {
            currentScale = 1;
            currentOffsetX = 0;
            currentOffsetY = 0;
            updateVisualization();
        }

        // Step 4: Structural Design Calculations
        
        // One-Way Shear Capacity Calculation
        function calculateOneWayShear() {
            if (!analysisResultsData.pileSummary || analysisResultsData.pileSummary.length === 0) {
                alert('Please run the analysis first to generate pile forces.');
                return;
            }

            const params = getDesignParameters();
            const phi_v = 0.90;  // Strength reduction factor for shear
            const beta = 2.0;    // per LRFD 5.8.3.4.1
            const fc = params.concrete_fc_ksi;
            const footing_x = analysisResultsData.groupProperties.footingLength;
            const footing_y = analysisResultsData.groupProperties.footingWidth;
            const dv = analysisResultsData.groupProperties.shearDepth;

            // Shear capacity along X direction
            const vc1_x = phi_v * 0.0316 * beta * Math.sqrt(fc) * footing_x * dv * 144;
            const vc2_x = 0.25 * fc * footing_x * dv * 144;
            const vn_x = Math.min(vc1_x, vc2_x);

            // Shear capacity along Y direction  
            const vc1_y = phi_v * 0.0316 * beta * Math.sqrt(fc) * footing_y * dv * 144;
            const vc2_y = 0.25 * fc * params.footing_thickness_ft * dv * 144;
            const vn_y = Math.min(vc1_y, vc2_y);

            // Calculate applied shear forces
            const pileSummary = analysisResultsData.pileSummary;
            const pile_center_x = pileSummary.reduce((sum, p) => sum + p.x, 0) / pileSummary.length;
            const pile_center_y = pileSummary.reduce((sum, p) => sum + p.y, 0) / pileSummary.length;
            
            const col_face_x_left = pile_center_x - params.column_x_dim_ft / 2;
            const col_face_x_right = pile_center_x + params.column_x_dim_ft / 2;
            const col_face_y_bottom = pile_center_y - params.column_y_dim_ft / 2;
            const col_face_y_top = pile_center_y + params.column_y_dim_ft / 2;

            const Vuy1 = pileSummary.filter(p => p.x < col_face_x_left).reduce((sum, p) => sum + p.pmax, 0);
            const Vuy2 = pileSummary.filter(p => p.x > col_face_x_right).reduce((sum, p) => sum + p.pmax, 0);
            const Vux1 = pileSummary.filter(p => p.y < col_face_y_bottom).reduce((sum, p) => sum + p.pmax, 0);
            const Vux2 = pileSummary.filter(p => p.y > col_face_y_top).reduce((sum, p) => sum + p.pmax, 0);

            // Safety checks
            const safe_x = (Vux1 < vn_x && Vux2 < vn_x);
            const safe_y = (Vuy1 < vn_y && Vuy2 < vn_y);

            // Display results
            const resultsDiv = document.getElementById('oneWayShearContent');
            resultsDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">φ<sub>v</sub> (Strength Reduction Factor):</span>
                    <span class="result-value">${phi_v}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">β (LRFD Factor):</span>
                    <span class="result-value">${beta}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>n,x</sub> (X-Direction Capacity):</span>
                    <span class="result-value">${vn_x.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>n,y</sub> (Y-Direction Capacity):</span>
                    <span class="result-value">${vn_y.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>ux1</sub> (Applied Shear X1):</span>
                    <span class="result-value">${Vux1.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>ux2</sub> (Applied Shear X2):</span>
                    <span class="result-value">${Vux2.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>uy1</sub> (Applied Shear Y1):</span>
                    <span class="result-value">${Vuy1.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>uy2</sub> (Applied Shear Y2):</span>
                    <span class="result-value">${Vuy2.toFixed(2)} kips</span>
                </div>
                <div class="safety-check ${safe_x ? 'safe' : 'unsafe'}">
                    X-Direction: ${safe_x ? 'SAFE' : 'NOT SAFE'}
                </div>
                <div class="safety-check ${safe_y ? 'safe' : 'unsafe'}">
                    Y-Direction: ${safe_y ? 'SAFE' : 'NOT SAFE'}
                </div>
            `;

            document.getElementById('oneWayShearResults').style.display = 'block';
        }

        // Two-Way Shear (Punching Shear) Calculation
        function calculateTwoWayShear() {
            if (!analysisResultsData.pileSummary || analysisResultsData.pileSummary.length === 0) {
                alert('Please run the analysis first to generate pile forces.');
                return;
            }

            const params = getDesignParameters();
            const pileSummary = analysisResultsData.pileSummary;

            // Find corner pile with maximum load
            const xCoords = pileSummary.map(p => p.x);
            const yCoords = pileSummary.map(p => p.y);
            const minX = Math.min(...xCoords), maxX = Math.max(...xCoords);
            const minY = Math.min(...yCoords), maxY = Math.max(...yCoords);
            
            const cornerPiles = pileSummary.filter(p => 
                (p.x === minX || p.x === maxX) && (p.y === minY || p.y === maxY)
            );
            const Vu = Math.max(...cornerPiles.map(p => p.pmax));

            // Calculate critical section parameters
            const dv = analysisResultsData.groupProperties.shearDepth;
            const dv_in = dv * 12;
            const dv2_ft = 0.5 * dv;
            
            const pile_size_ft = params.pile_size_in / 12;
            const pile_edge_ft = params.pile_overhang_in / 12;
            
            const b0_opt1 = 4 * (pile_size_ft + 2 * dv2_ft);
            const b0_opt2 = pile_size_ft + 2 * (dv2_ft + pile_edge_ft);
            const b0_ft = Math.min(b0_opt1, b0_opt2);
            const b0_in = b0_ft * 12;

            // Nominal shear resistance
            const beta_c = 2.0;
            const fc = params.concrete_fc_ksi;
            const phi = 0.9;
            
            const Vn1 = (0.063 + 0.126 / beta_c) * Math.sqrt(fc) * b0_in * dv_in;
            const Vn2 = 0.126 * Math.sqrt(fc) * b0_in * dv_in;
            const Vn = Math.min(Vn1, Vn2);
            const phiVn = phi * Vn;

            // Safety check
            const safe = phiVn > Vu;
            const dcRatio = Vu / phiVn;

            // Display results
            const resultsDiv = document.getElementById('twoWayShearContent');
            resultsDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Critical Pile Load (V<sub>u</sub>):</span>
                    <span class="result-value">${Vu.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Critical Section Perimeter (b<sub>0</sub>):</span>
                    <span class="result-value">${b0_in.toFixed(2)} in</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Effective Depth (d<sub>v</sub>):</span>
                    <span class="result-value">${dv_in.toFixed(2)} in</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>n1</sub> (Nominal Capacity 1):</span>
                    <span class="result-value">${Vn1.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">V<sub>n2</sub> (Nominal Capacity 2):</span>
                    <span class="result-value">${Vn2.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">φV<sub>n</sub> (Design Capacity):</span>
                    <span class="result-value">${phiVn.toFixed(2)} kips</span>
                </div>
                <div class="result-item">
                    <span class="result-label">D/C Ratio (V<sub>u</sub>/φV<sub>n</sub>):</span>
                    <span class="result-value">${dcRatio.toFixed(3)}</span>
                </div>
                <div class="safety-check ${safe ? 'safe' : 'unsafe'}">
                    Punching Shear: ${safe ? 'SAFE' : 'NOT SAFE'}
                </div>
            `;

            document.getElementById('twoWayShearResults').style.display = 'block';
        }

        // Flexural Design Calculation
        function calculateFlexuralDesign() {
            if (!analysisResultsData.pileSummary || analysisResultsData.pileSummary.length === 0) {
                alert('Please run the analysis first to generate pile forces.');
                return;
            }

            const params = getDesignParameters();
            const pileSummary = analysisResultsData.pileSummary;
            const pile_center_x = pileSummary.reduce((sum, p) => sum + p.x, 0) / pileSummary.length;
            const pile_center_y = pileSummary.reduce((sum, p) => sum + p.y, 0) / pileSummary.length;
            
            const footing_x = analysisResultsData.groupProperties.footingLength;
            const footing_y = analysisResultsData.groupProperties.footingWidth;

            // X-direction calculations
            const edge_x = (footing_x - params.column_x_dim_ft) / 2;
            const crit_x = edge_x - params.pile_overhang_in / 12;
            
            const col_x_min = pile_center_x - params.column_x_dim_ft / 2;
            const col_x_max = pile_center_x + params.column_x_dim_ft / 2;
            
            const Pu_right = pileSummary.filter(p => p.x > col_x_max).reduce((sum, p) => sum + p.pmax, 0);
            const Pu_left = pileSummary.filter(p => p.x < col_x_min).reduce((sum, p) => sum + p.pmax, 0);
            const Pu_x = Math.max(Pu_right, Pu_left);
            
            const Mpile_x = Pu_x * crit_x;
            const Mfooting_x = footing_x * params.footing_thickness_ft * 0.15 * (edge_x * edge_x / 2);
            const Mstrength_x = Mpile_x - 0.9 * Mfooting_x;
            const Mservice_x = Mpile_x - 1.0 * Mfooting_x;
            const Multimate_x = Math.max(Mstrength_x, Mservice_x);

            // Y-direction calculations
            const edge_y = (footing_y - params.column_y_dim_ft) / 2;
            const crit_y = edge_y - params.pile_overhang_in / 12;
            
            const col_y_min = pile_center_y - params.column_y_dim_ft / 2;
            const col_y_max = pile_center_y + params.column_y_dim_ft / 2;
            
            const Pu_above = pileSummary.filter(p => p.y > col_y_max).reduce((sum, p) => sum + p.pmax, 0);
            const Pu_below = pileSummary.filter(p => p.y < col_y_min).reduce((sum, p) => sum + p.pmax, 0);
            const Pu_y = Math.max(Pu_above, Pu_below);
            
            const Mpile_y = Pu_y * crit_y;
            const Mfooting_y = footing_y * params.footing_thickness_ft * 0.15 * (edge_y * edge_y / 2);
            const Mstrength_y = Mpile_y - 0.9 * Mfooting_y;
            const Mservice_y = Mpile_y - 1.0 * Mfooting_y;
            const Multimate_y = Math.max(Mstrength_y, Mservice_y);

            // Steel reinforcement calculations
            const de = analysisResultsData.groupProperties.effectiveDepth;
            const D = params.footing_thickness_ft;
            const fc = params.concrete_fc_ksi;
            const fy = params.reinforcing_steel_fy_ksi;

            const Multimate_x_per_ft = Multimate_x / footing_x;
            const Multimate_y_per_ft = Multimate_y / footing_y;

            const denominator_x = 1.7 * 0.9 * fc * 144 * de * de;
            const denominator_y = 1.7 * 0.9 * fc * 144 * de * de;

            const As_x = 0.85 * (fc / fy) * footing_x * D * 
                       (1 - Math.sqrt(1 - (4 * Multimate_x_per_ft) / denominator_x));
            const As_y = 0.85 * (fc / fy) * footing_y * D * 
                       (1 - Math.sqrt(1 - (4 * Multimate_y_per_ft) / denominator_y));

            // Display results
            const resultsDiv = document.getElementById('flexuralContent');
            resultsDiv.innerHTML = `
                <table class="design-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>X-Direction</th>
                            <th>Y-Direction</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Critical Distance (ft)</strong></td>
                            <td>${crit_x.toFixed(3)}</td>
                            <td>${crit_y.toFixed(3)}</td>
                        </tr>
                        <tr>
                            <td><strong>Critical Pile Load (kips)</strong></td>
                            <td>${Pu_x.toFixed(2)}</td>
                            <td>${Pu_y.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Pile Moment (kip-ft)</strong></td>
                            <td>${Mpile_x.toFixed(2)}</td>
                            <td>${Mpile_y.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Footing Weight Moment (kip-ft)</strong></td>
                            <td>${Mfooting_x.toFixed(2)}</td>
                            <td>${Mfooting_y.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Strength I Moment (kip-ft)</strong></td>
                            <td>${Mstrength_x.toFixed(2)}</td>
                            <td>${Mstrength_y.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Service I Moment (kip-ft)</strong></td>
                            <td>${Mservice_x.toFixed(2)}</td>
                            <td>${Mservice_y.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Ultimate Moment (kip-ft)</strong></td>
                            <td>${Multimate_x.toFixed(2)}</td>
                            <td>${Multimate_y.toFixed(2)}</td>
                        </tr>
                        <tr style="background: rgba(52, 152, 219, 0.1);">
                            <td><strong>Required Steel Area (in²)</strong></td>
                            <td><strong>${As_x.toFixed(2)}</strong></td>
                            <td><strong>${As_y.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;

            document.getElementById('flexuralResults').style.display = 'block';
        }

        // Generate Complete Design Summary
        function generateDesignSummary() {
            if (!analysisResultsData.pileSummary || analysisResultsData.pileSummary.length === 0) {
                alert('Please run the analysis first to generate design data.');
                return;
            }

            // Run all calculations first
            calculateOneWayShear();
            calculateTwoWayShear();
            calculateFlexuralDesign();

            const params = getDesignParameters();
            const resultsDiv = document.getElementById('designSummaryContent');
            
            resultsDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; font-family: 'Inter', sans-serif;">
                        🏗️ Complete Pile Cap Design Summary
                    </h3>
                    <p style="color: #6c757d; font-style: italic;">
                        Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
                    </p>
                </div>

                <div class="calculation-section">
                    <h4>📋 Design Parameters</h4>
                    <table class="design-table">
                        <tr><td><strong>Concrete Strength (f'c)</strong></td><td>${params.concrete_fc_ksi} ksi</td></tr>
                        <tr><td><strong>Steel Yield Strength (fy)</strong></td><td>${params.reinforcing_steel_fy_ksi} ksi</td></tr>
                        <tr><td><strong>Footing Dimensions</strong></td><td>${analysisResultsData.groupProperties.footingLength.toFixed(2)} × ${analysisResultsData.groupProperties.footingWidth.toFixed(2)} ft</td></tr>
                        <tr><td><strong>Footing Thickness</strong></td><td>${params.footing_thickness_ft} ft</td></tr>
                        <tr><td><strong>Column Dimensions</strong></td><td>${params.column_x_dim_ft} × ${params.column_y_dim_ft} ft</td></tr>
                        <tr><td><strong>Number of Piles</strong></td><td>${analysisResultsData.pileSummary.length}</td></tr>
                        <tr><td><strong>Pile Size</strong></td><td>${params.pile_size_in} in diameter</td></tr>
                    </table>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                    <div class="safety-check safe">
                        Analysis Complete<br>
                        All structural checks performed according to LRFD specifications
                    </div>
                    <div class="safety-check" style="background: rgba(52, 152, 219, 0.1); border-color: #3498db; color: #2980b9;">
                        Ready for Final Design<br>
                        Review all calculations and verify safety factors
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="exportDesignReport()" class="calc-button">
                        📥 Export Design Report
                    </button>
                </div>
            `;

            document.getElementById('designSummary').style.display = 'block';
        }

        // Initialize canvas interaction when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultData();
            setupCanvasInteraction();
        });

        // Toggle Phase Visibility
        function togglePhase(phaseNumber) {
            const content = document.getElementById('phase' + phaseNumber);
            const arrow = document.getElementById('arrow' + phaseNumber);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

        // Event listeners
        document.getElementById('useDefaultData').addEventListener('click', loadDefaultData);
        document.getElementById('clearData').addEventListener('click', clearAllData);
        document.getElementById('parseData').addEventListener('click', parsePastedData);
        document.getElementById('addRow').addEventListener('click', addNewRow);
        document.getElementById('runAnalysis').addEventListener('click', runForceDistributionAnalysis);

        // Add event listeners for 3D view updates
        const elevationInputs = [
            'water_elev', 'top_footing_elev', 'footing_thick', 'pile_length',
            'column_width', 'column_depth', 'footing_width', 'footing_length',
            'pile_diameter', 'piles_x', 'piles_y', 'spacing_x', 'spacing_y'
        ];
        
        elevationInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', update3DView);
                element.addEventListener('change', update3DView);
            }
        });

        // Initialize with default data on page load
        loadDefaultData();
        setTimeout(update3DView, 1000); // Update 3D view after loading default data
    </script>
</body>
</html>
