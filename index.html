<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pile Cap Design - Step by Step</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: #1a365d;
            color: white;
            padding: 24px 30px;
            text-align: center;
            border-bottom: 3px solid #2a69ac;
        }

        .header h1 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
            margin: 0;
        }

        /* Elevation Visualization Styles */
        .elevation-container {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            padding: 20px;
            text-align: center;
        }

        .elevation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .elevation-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .view-controls {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            background: #2a69ac;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: #1e5a96;
        }

        #plot3d {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .elevation-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #555;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }

        /* Results Section Styles */
        .results-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .results-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .results-section p {
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .status.safe {
            color: #27ae60;
            background: #d5f4e6;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #27ae60;
        }

        .status.warning {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #e74c3c;
        }

        .reinforcement {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #27ae60;
        }

        /* Design Summary Styles */
        .summary-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .summary-container h3 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.4rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-section h4 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .summary-section ul {
            list-style: none;
            padding: 0;
        }

        .summary-section li {
            padding: 6px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .summary-section li:last-child {
            border-bottom: none;
        }

        .status-list .status-safe {
            color: #27ae60;
        }

        .overall-status {
            font-size: 1.1rem;
            color: #2980b9;
            background: #ebf3fd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .summary-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .summary-note p {
            margin: 0;
            color: #856404;
        }

        /* Pile Force Visualization */
        #forceCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: crosshair;
        }

        #hoverTooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 5;
            font-size: 0.85rem;
        }

        /* Keep the two overlays in opposite corners and non-overlapping */
        #visualizationLegend{
            top: 16px !important;
            right: 16px !important;
            z-index: 3;
            pointer-events: none;
        }

        #colorScale{
            bottom: 16px !important;
            left: 16px !important;
            z-index: 2;
            pointer-events: none;
        }

        /* On narrow screens, stack: move legend below color scale */
        @media (max-width: 700px){
            #visualizationLegend{
                top: auto !important;
                right: 16px !important;
                bottom: 16px !important;
            }
        }

        /* Give overlays breathing room */
        #forceVisualization{ padding: 6px; }

        /* Let the tooltip fully show inside the visualization box */
        #forceVisualization { overflow: visible !important; }

        /* These two overlays shouldn't eat mouse events or overlap awkwardly */
        #visualizationLegend, #colorScale { pointer-events: none; }

        /* Tooltip above everything */
        #hoverTooltip { z-index: 1000; }

        /* Let the tooltip fully show inside the visualization box */
        #forceVisualization { overflow: visible !important; }

        /* These two overlays shouldn't eat mouse events or overlap awkwardly */
        #visualizationLegend, #colorScale { pointer-events: none; }

        /* Tooltip above everything */
        #hoverTooltip { z-index: 1000; }

        .phase-indicator {
            background: #34495e;
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .content {
            padding: 40px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .code-container {
            background: #2d3748;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .code-container::before {
            content: "Python";
            position: absolute;
            top: 10px;
            right: 15px;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .code {
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre;
        }

        .code .comment {
            color: #68d391;
        }

        .code .keyword {
            color: #9f7aea;
        }

        .code .string {
            color: #fbb6ce;
        }

        .code .number {
            color: #f6ad55;
        }

        .code .function {
            color: #63b3ed;
        }

        .description {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .description h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description p {
            color: #5a6c7d;
            margin-bottom: 10px;
        }

        .next-step {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }

        .next-step h3 {
            margin-bottom: 10px;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .parameter-category {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3498db;
        }

        .parameter-category h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .parameter {
            display: flex;
            flex-direction: column;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .parameter:last-child {
            border-bottom: none;
        }

        .parameter label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .parameter input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .parameter input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background: white;
        }

        .parameter input[type="text"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Load Cases Section Styles */
        .load-controls {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-file {
            background: #28a745;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-file:hover {
            background: #218838;
        }

        .btn-add {
            background: #17a2b8;
            color: white;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .paste-section {
            margin-top: 20px;
        }

        .paste-section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .paste-section textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        .table-container {
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }

        #loadCasesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        #loadCasesTable th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #loadCasesTable td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        #loadCasesTable input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
            font-size: 0.85rem;
        }

        #loadCasesTable input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.2);
        }

        #loadCasesTable tr:hover {
            background: #f8f9fa;
        }

        .data-summary {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
        }

        .data-summary h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        #summaryStats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #summaryStats span {
            color: #495057;
            font-size: 0.9rem;
        }

        #summaryStats strong {
            color: #2c3e50;
        }

        /* Analysis Section Styles */
        .analysis-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .results-section {
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .results-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }

        .prop-label {
            font-weight: 500;
            color: #495057;
        }

        .prop-value {
            font-weight: 600;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        #forceDistributionTable,
        #pileForceSummary {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        #forceDistributionTable th,
        #forceDistributionTable td,
        #pileForceSummary th,
        #pileForceSummary td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        #forceDistributionTable th,
        #pileForceSummary th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #forceDistributionTable tr:nth-child(even),
        #pileForceSummary tr:nth-child(even) {
            background: #f8f9fa;
        }

        #forceDistributionTable tr:hover,
        #pileForceSummary tr:hover {
            background: #e3f2fd;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card h5 {
            margin-bottom: 10px;
            font-size: 1rem;
            opacity: 0.9;
        }

        .summary-card p {
            margin-bottom: 5px;
        }

        .summary-card strong {
            font-size: 1.3rem;
            display: block;
            margin-bottom: 5px;
        }

        /* Enhanced Visualization Styles */
        #forceVisualization {
            position: relative;
            width: 100%;
            height: 700px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
            margin-top: 20px;
            overflow: hidden;
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
        }

        #forceCanvas {
            display: block;
            margin: 0 auto;
            cursor: crosshair;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #hoverTooltip {
            position: absolute;
            background: linear-gradient(145deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 400;
            pointer-events: none;
            display: none;
            z-index: 1000;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 280px;
        }

        #colorScale {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background: rgba(255,255,255,0.95);
            padding: 18px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 0 0 1px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.6);
            min-width: 150px;
        }

        /* Phase Headers and Content */
        .phase-header {
            background: #2a69ac;
            color: white;
            padding: 18px 24px;
            margin: 16px 0 0 0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #1e5a96;
        }

        .phase-header:hover {
            background: #1e5a96;
            border-color: #1a4f82;
        }

        .phase-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .toggle-arrow {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .phase-content {
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 24px;
            margin-bottom: 16px;
            display: none;
        }

        /* Phase 4 - Structural Design Calculations Styling */
        .calculation-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .calculation-section h3 {
            color: #2c3e50;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .formula-box {
            background: rgba(255,255,255,0.9);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .formula-box h4 {
            color: #2980b9;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .formula {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 14px;
            text-align: center;
            color: #2c3e50;
        }

        .parameter-explanation {
            background: rgba(52, 152, 219, 0.05);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-top: 15px;
        }

        .parameter-explanation p {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .parameter-explanation ul {
            margin: 0;
            padding-left: 20px;
        }

        .parameter-explanation li {
            margin: 5px 0;
            color: #495057;
            font-size: 13px;
        }

        .calc-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            margin: 15px 0;
        }

        .calc-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .results-section {
            background: rgba(39, 174, 96, 0.05);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-section h4 {
            color: #27ae60;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .result-item {
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .result-value {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 700;
            color: #e74c3c;
        }

        .safety-check {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }

        .safety-check.safe {
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .safety-check.unsafe {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .design-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .design-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .design-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .design-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .design-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        #visualizationLegend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 18px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 0 0 1px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.6);
        }

        .visualization-controls {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .viz-btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 12px 24px;
            margin: 0 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .viz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .viz-btn-primary {
            background: linear-gradient(145deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .viz-btn-secondary {
            background: linear-gradient(145deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .control-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                margin-bottom: 10px;
                text-align: center;
            }
            
            .table-wrapper {
                font-size: 0.8rem;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        /* --- Always-expanded steps; remove expand affordances --- */
        .phase-header { cursor: default; }
        .toggle-arrow { display: none !important; }   /* hide the ▼ in headers */
        .phase-content { display: block !important; } /* keep content open */

        /* --- Hide the "Phase X Complete!" ribbons & misc filler --- */
        .next-step { display: none !important; }

        /* Optional: de-emphasize any blank results shells (just in case) */
        .results-section:empty { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pile Cap Design</h1>
            <p>Structural Analysis - Step by Step Implementation</p>
        </div>
        
        <!-- 3D Interactive Visualization -->
        <div class="elevation-container">
            <div class="elevation-header">
                <h3>Interactive 3D Structure View</h3>
                <div class="view-controls">
                    <button onclick="resetView()" class="btn-small">Reset View</button>
                    <button onclick="topView()" class="btn-small">Top View</button>
                    <button onclick="sideView()" class="btn-small">Side View</button>
                </div>
            </div>
            <div id="plot3d" style="width:100%; height:500px;"></div>
            <div class="elevation-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #87CEEB;"></div>
                    <span>Water Level</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8B4513;"></div>
                    <span>Soil</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #C0C0C0;"></div>
                    <span>Concrete</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2F4F4F;"></div>
                    <span>Steel Column</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1E90FF;"></div>
                    <span>Piles</span>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Phase 1: Design Parameters -->
            <div class="phase-header" onclick="togglePhase(1)">
                <h2>Step 1: Design Data Input & Pile Coordinate Generation</h2>
                <span class="toggle-arrow" id="arrow1">▼</span>
            </div>
            
            <div class="phase-content" id="phase1">
            <div class="parameter-grid">
                <div class="parameter-category">
                    <h4>Material Properties</h4>
                    <div class="parameter">
                        <label for="concrete_fc">Concrete Strength (f'c) - ksi:</label>
                        <input type="number" id="concrete_fc" value="5.5" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="steel_fy">Steel Strength (fy) - ksi:</label>
                        <input type="number" id="steel_fy" value="60" step="1">
                    </div>
                    <div class="parameter">
                        <label for="cover">Reinforcing Cover - in:</label>
                        <input type="number" id="cover" value="4.0" step="0.1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Column Dimensions</h4>
                    <div class="parameter">
                        <label for="column_x">Column X Dimension - ft:</label>
                        <input type="number" id="column_x" value="14.00" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="column_y">Column Y Dimension - ft:</label>
                        <input type="number" id="column_y" value="9.00" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="ecc_x">Eccentricity X - ft:</label>
                        <input type="number" id="ecc_x" value="0" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="ecc_y">Eccentricity Y - ft:</label>
                        <input type="number" id="ecc_y" value="0" step="0.01">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Footing Properties</h4>
                    <div class="parameter">
                        <label for="footing_thickness">Footing Thickness - ft:</label>
                        <input type="number" id="footing_thickness" value="9" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="pile_embedment">Pile Embedment - in:</label>
                        <input type="number" id="pile_embedment" value="12" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_overhang">Pile Overhang - in:</label>
                        <input type="number" id="pile_overhang" value="19.5" step="0.1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Site Conditions</h4>
                    <div class="parameter">
                        <label for="ground_elevation">Ground Elevation - ft:</label>
                        <input type="number" id="ground_elevation" value="73.4" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="footing_top_elevation">Footing Top Elevation - ft:</label>
                        <input type="number" id="footing_top_elevation" value="70.4" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="water_elevation">Water Elevation - ft:</label>
                        <input type="number" id="water_elevation" value="68.0" step="0.1">
                    </div>
                    <div class="parameter">
                        <label for="soil_weight">Soil Weight - ksf:</label>
                        <input type="number" id="soil_weight" value="0.115" step="0.001">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Pile Configuration</h4>
                    <div class="parameter">
                        <label for="pile_no_x">Number of Piles X:</label>
                        <input type="number" id="pile_no_x" value="8" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_no_y">Number of Piles Y:</label>
                        <input type="number" id="pile_no_y" value="6" step="1">
                    </div>
                    <div class="parameter">
                        <label for="pile_spacing_x">X Spacing - ft:</label>
                        <input type="number" id="pile_spacing_x" value="4.15" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_spacing_y">Y Spacing - ft:</label>
                        <input type="number" id="pile_spacing_y" value="3.75" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_diameter">Pile Diameter - in:</label>
                        <input type="number" id="pile_diameter" value="15" step="1">
                    </div>
                </div>

                <div class="parameter-category">
                    <h4>Pile Capacity</h4>
                    <div class="parameter">
                        <label for="bearing_capacity">Bearing Capacity - tons:</label>
                        <input type="number" id="bearing_capacity" value="270" step="1">
                    </div>
                    <div class="parameter">
                        <label for="side_friction">Side Friction - tons:</label>
                        <input type="number" id="side_friction" value="270" step="1">
                    </div>
                    <div class="parameter">
                        <label for="compression_factor">Compression Factor:</label>
                        <input type="number" id="compression_factor" value="0.75" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="uplift_factor">Uplift Factor:</label>
                        <input type="number" id="uplift_factor" value="0.6" step="0.01">
                    </div>
                    <div class="parameter">
                        <label for="pile_tip_elevation">Pile Tip Elevation - ft:</label>
                        <input type="number" id="pile_tip_elevation" value="34" step="1">
                    </div>
                    <div class="parameter">
                        <label for="boring">Boring Reference:</label>
                        <input type="text" id="boring" value="P41-1">
                    </div>
                </div>
            </div>

            <div class="next-step">
                <h3>Phase 1 Complete!</h3>
                <p>Design parameters established and pile coordinates generated successfully.</p>
                <p><strong>Moving to Phase 2:</strong> Load Cases Input Section</p>
            </div>
            </div>

            <!-- Phase 2: Load Cases -->
            <div class="phase-header" onclick="togglePhase(2)">
                <h2>Step 2: Load Cases Data Input</h2>
                <span class="toggle-arrow" id="arrow2">▼</span>
            </div>
            
            <div class="phase-content" id="phase2">
                <div class="load-controls">
                    <div class="control-buttons">
                        <button id="useDefaultData" class="btn btn-primary">Use Default Load Cases</button>
                        <button id="clearData" class="btn btn-secondary">Clear All Data</button>
                        <label for="fileInput" class="btn btn-file">
                            Import from File
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        </label>
                    </div>
                    
                    <div class="paste-section">
                        <h4>Paste from Excel/CSV:</h4>
                        <textarea id="pasteArea" placeholder="Paste your load cases data here (tab-separated or comma-separated)&#10;Format: LoadCase, Factor, Fx, Fy, Fz, Mx, My&#10;Example:&#10;1, 1.00, 230, 233, 6764, 10600, 12710&#10;2, 1.00, -230, 233, 4876, 10590, 10160"></textarea>
                        <button id="parseData" class="btn btn-primary">Parse Pasted Data</button>
                    </div>
                </div>

                <div class="table-container">
                    <h4>Current Load Cases:</h4>
                    <div class="table-wrapper">
                        <table id="loadCasesTable">
                            <thead>
                                <tr>
                                    <th>Load Case</th>
                                    <th>Factor</th>
                                    <th>Fx (k)</th>
                                    <th>Fy (k)</th>
                                    <th>Fz (k)</th>
                                    <th>Mx (k-ft)</th>
                                    <th>My (k-ft)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loadCasesBody">
                                <!-- Load cases will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="addRow" class="btn btn-add">Add New Row</button>
                </div>

                <div class="data-summary">
                    <h4>Data Summary:</h4>
                    <div id="summaryStats">
                        <span>Total Load Cases: <strong id="totalCases">0</strong></span>
                        <span>Max Fx: <strong id="maxFx">-</strong></span>
                        <span>Max Fy: <strong id="maxFy">-</strong></span>
                        <span>Max Fz: <strong id="maxFz">-</strong></span>
                    </div>
                </div>

                <div class="next-step" style="margin-top: 30px;">
                    <h3>Phase 2 Ready!</h3>
                    <p>Load cases configured successfully.</p>
                    <p><strong>Moving to Phase 3:</strong> Pile Force Distribution Analysis</p>
                </div>
            </div>

            <!-- Step 3: Force Distribution Analysis -->
            <div class="phase-header" onclick="togglePhase(3)">
                <h2>Step 3: Pile Force Distribution Analysis</h2>
                <span class="toggle-arrow" id="arrow3">▼</span>
            </div>
            
            <div class="phase-content" id="phase3">
                <div class="analysis-controls">
                    <button id="runAnalysis" class="btn btn-primary">Run Force Distribution Analysis</button>
                    <button id="downloadResults" class="btn btn-secondary" style="display: none;">Download Results</button>
                </div>

                <div id="analysisResults" style="display: none;">
                    <div class="results-section">
                        <h4>Pile Group Properties:</h4>
                        <div id="groupProperties" class="properties-grid">
                            <!-- Group properties will be populated here -->
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Force Distribution Table:</h4>
                        <div class="table-wrapper">
                            <table id="forceDistributionTable">
                                <thead id="forceTableHead">
                                    <!-- Headers will be populated dynamically -->
                                </thead>
                                <tbody id="forceTableBody">
                                    <!-- Force distribution data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Pile Force Summary:</h4>
                        <div class="table-wrapper">
                            <table id="pileForceSummary">
                                <thead>
                                    <tr>
                                        <th>Pile No.</th>
                                        <th>X (ft)</th>
                                        <th>Y (ft)</th>
                                        <th>Pmax (k)</th>
                                        <th>Max LC</th>
                                        <th>Pmin (k)</th>
                                        <th>Min LC</th>
                                    </tr>
                                </thead>
                                <tbody id="pileSummaryBody">
                                    <!-- Pile summary will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>Analysis Summary:</h4>
                        <div id="analysisSummary" class="summary-cards">
                            <!-- Analysis summary will be populated here -->
                        </div>
                    </div>

                    <div class="results-section">
                        <h4>🎯 Interactive Pile Force Distribution Visualization</h4>
                        <div class="description" style="margin-bottom: 20px;">
                            <p>This interactive visualization displays the pile force distribution in a top view with beautiful hover effects and zoom capabilities. Each pile is color-coded based on its maximum force value.</p>
                            <p><strong>Controls:</strong> Hover over piles for details, scroll to zoom, click and drag to pan, use Reset View to return to default.</p>
                        </div>
                        
                        <div id="forceVisualization">
                            <canvas id="forceCanvas" width="900" height="650"></canvas>
                            
                            <!-- Interactive Tooltip -->
                            <div id="hoverTooltip">
                                <div id="tooltipContent"></div>
                            </div>
                            

                        </div>
                        
                        <div class="visualization-controls">
                            <button onclick="updateVisualization()" class="viz-btn viz-btn-primary">
                                🔄 Update Visualization
                            </button>
                            <button onclick="resetVisualizationView()" class="viz-btn viz-btn-secondary">
                                🎯 Reset View
                            </button>
                            <button onclick="exportVisualization()" class="viz-btn viz-btn-secondary">
                                📥 Export Image
                            </button>
                        </div>
                    </div>
                </div>

                <div class="next-step" style="margin-top: 30px;">
                    <h3>Phase 3 Ready!</h3>
                    <p>Force distribution analysis complete.</p>
                    <p><strong>Next:</strong> Ready for Phase 4 - Structural Design Checks!</p>
                </div>
            </div>

            <!-- Step 4: Structural Design Calculations -->
            <div class="phase-header" onclick="togglePhase(4)">
                <h2>Step 4: Structural Design Calculations</h2>
                <span class="toggle-arrow" id="arrow4">▼</span>
            </div>
            
            <div class="phase-content" id="phase4">
                <!-- 🔧 Factored Demand Inputs (Step 4) -->
                <div class="calculation-section" id="demandInputs">
                  <h3>Factored Demands (from analysis)</h3>
                  <div class="parameter-grid">
                    <div class="parameter-category">
                      <h4>One-Way Shear (per-ft strip)</h4>
                      <div class="parameter">
                        <label for="VuOneWayPerFt">V<sub>u</sub> (kips/ft):</label>
                        <input type="number" id="VuOneWayPerFt" value="45" step="0.1" />
                      </div>
                      <p style="font-size:.9rem;color:#6c757d;margin-top:6px;">
                        Use demand at a section located d<sub>v</sub> from the face.
                      </p>
                    </div>

                    <div class="parameter-category">
                      <h4>Punching (Two-Way) Shear</h4>
                      <div class="parameter">
                        <label for="VuPunchKips">V<sub>u</sub> (kips):</label>
                        <input type="number" id="VuPunchKips" value="500" step="1" />
                      </div>
                      <p style="font-size:.9rem;color:#6c757d;margin-top:6px;">
                        Demand on critical perimeter at d<sub>v</sub>/2 from faces.
                      </p>
                    </div>

                    <div class="parameter-category">
                      <h4>Flexure</h4>
                      <div class="parameter">
                        <label for="MuKipFt">M<sub>u</sub> (kip-ft):</label>
                        <input type="number" id="MuKipFt" value="200" step="1" />
                      </div>
                      <p style="font-size:.9rem;color:#6c757d;margin-top:6px;">
                        Provide governing factored moment for the design strip.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- 🔎 Pull demands from a selected Load Case -->
                <div class="calculation-section" id="lcPickerBlock">
                  <h3>Pull Demands from Load Case</h3>
                  <div class="parameter-grid">
                    <div class="parameter-category">
                      <h4>Select Source</h4>
                      <div class="parameter">
                        <label for="lcPicker">Load Case:</label>
                        <select id="lcPicker"></select>
                      </div>
                      <div class="parameter">
                        <label for="stripDir">Strip Direction:</label>
                        <select id="stripDir">
                          <option value="X">X (span along X; use M<sub>y</sub>)</option>
                          <option value="Y">Y (span along Y; use M<sub>x</sub>)</option>
                        </select>
                      </div>
                      <button class="btn btn-primary" id="applyFromLC" type="button">Use from Selected LC</button>
                      <p style="font-size:.9rem;color:#6c757d;margin-top:8px;">
                        One-way V<sub>u</sub> per-ft ≈ |F<sub>z</sub>| divided by cap width in the chosen strip direction.<br>
                        Punching V<sub>u</sub> ≈ |F<sub>z</sub>| at the column.<br>
                        Strip moment M<sub>u</sub> per-ft ≈ |M<sub>dir⊥</sub>| divided by cap width ⟂ to strip.
                      </p>
                      <div id="lcPickerNote" style="color:#6c757d;font-size:.9rem;margin-top:6px;"></div>
                    </div>
                    <div class="parameter-category">
                      <h4>Cap Dimensions (derived)</h4>
                      <div class="parameter"><label>Cap Length (X):</label><div id="capLenXLabel">—</div></div>
                      <div class="parameter"><label>Cap Width (Y):</label><div id="capLenYLabel">—</div></div>
                      <div class="parameter"><label>Overhang (each side):</label><div id="capOverhangLabel">—</div></div>
                    </div>
                  </div>
                </div>

                <!-- ✂️ One-Way Shear Slicer -->
                <div class="calculation-section" id="oneWaySlicer">
                  <h3>One-Way Shear Slicer (uses pile reactions from selected LC)</h3>
                  <div class="parameter-grid">
                    <div class="parameter-category">
                      <h4>Slice Setup</h4>
                      <div class="parameter">
                        <label for="sliceLC">Load Case:</label>
                        <select id="sliceLC"></select>
                      </div>
                      <div class="parameter">
                        <label for="sliceDir">Strip Direction:</label>
                        <select id="sliceDir">
                          <option value="X">X (section parallel to Y)</option>
                          <option value="Y">Y (section parallel to X)</option>
                        </select>
                      </div>
                      <div class="parameter">
                        <label for="sliceSide">Which side contributes:</label>
                        <select id="sliceSide">
                          <option value="+">Positive side (+X or +Y)</option>
                          <option value="-">Negative side (-X or -Y)</option>
                        </select>
                      </div>
                      <div class="parameter">
                        <label for="sliceOffset">Cut offset from column face (in):</label>
                        <input type="number" id="sliceOffset" value="0" step="1">
                      </div>
                      <div class="parameter">
                        <label for="avgBothSides">
                          <input type="checkbox" id="avgBothSides" />
                          Average both sides of the cut
                        </label>
                      </div>
                      <div class="parameter">
                        <label for="showColumnOutline">
                          <input type="checkbox" id="showColumnOutline" checked />
                          Show column outline on canvas
                        </label>
                      </div>
                      <button class="btn btn-primary" id="sliceCompute" type="button">Compute V<sub>u</sub> from Slice</button>
                      <button class="btn btn-secondary" id="slicePush" type="button" style="margin-left:8px;">Use as V<sub>u</sub> (per-ft)</button>
                      <p style="font-size:.9rem;color:#6c757d;margin-top:8px;">
                        Section is placed at <b>d<sub>v</sub></b> from the column face, plus optional offset. The shear is the sum of pile reactions on the chosen side of the cut. Per-ft demand divides by the section length.
                      </p>
                      <div id="sliceNote" style="color:#6c757d;font-size:.9rem;margin-top:6px;"></div>
                    </div>
                    <div class="parameter-category">
                      <h4>Slice Result</h4>
                      <div class="parameter"><label>Cut Location:</label><div id="sliceWhere">—</div></div>
                      <div class="parameter"><label>V<sub>u</sub> (kips):</label><div id="sliceVuK">—</div></div>
                      <div class="parameter"><label>Section Length (ft):</label><div id="sliceLenFt">—</div></div>
                      <div class="parameter"><label>V<sub>u</sub> per-ft (kips/ft):</label><div id="sliceVuPerFt">—</div></div>
                    </div>
                  </div>
                </div>

                <!-- One-Way Shear Check Section -->
                <div class="calculation-section">
                    <h3>One-Way Shear Capacity Check</h3>
                    <div class="formula-box">
                        <h4>Shear Capacity Formulas (LRFD 5.8.3.3)</h4>
                        <div class="formula">
                            <strong>V<sub>c1</sub> = φ<sub>v</sub> × 0.0316 × β × √f'<sub>c</sub> × b<sub>w</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>c2</sub> = 0.25 × f'<sub>c</sub> × b<sub>w</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n</sub> = min(V<sub>c1</sub>, V<sub>c2</sub>)</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>φ<sub>v</sub> = 0.90 (strength reduction factor for shear)</li>
                                <li>β = 2.0 (per LRFD 5.8.3.4.1)</li>
                                <li>f'<sub>c</sub> = concrete compressive strength (ksi)</li>
                                <li>b<sub>w</sub> = footing width (ft)</li>
                                <li>d<sub>v</sub> = effective shear depth (ft)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateOneWayShear()" class="calc-button">
                        🧮 Calculate One-Way Shear Capacity
                    </button>
                    
                    <div id="oneWayShearResults" class="results-section" style="display: none;">
                        <h4>One-Way Shear Results</h4>
                        <div id="oneWayShearContent"></div>
                    </div>
                </div>

                <!-- Two-Way Shear (Punching Shear) Check Section -->
                <div class="calculation-section">
                    <h3>⚡ Two-Way Shear (Punching Shear) Check</h3>
                    <div class="formula-box">
                        <h4>Punching Shear Formulas (LRFD 5.13.3.6)</h4>
                        <div class="formula">
                            <strong>V<sub>n1</sub> = (0.063 + 0.126/β<sub>c</sub>) × √f'<sub>c</sub> × b<sub>0</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n2</sub> = 0.126 × √f'<sub>c</sub> × b<sub>0</sub> × d<sub>v</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>V<sub>n</sub> = min(V<sub>n1</sub>, V<sub>n2</sub>)</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>β<sub>c</sub> = 2.0 (ratio of long side to short side of pile)</li>
                                <li>b<sub>0</sub> = perimeter of critical section (in)</li>
                                <li>φV<sub>n</sub> = φ × V<sub>n</sub> (design shear capacity)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateTwoWayShear()" class="calc-button">
                        🎯 Calculate Punching Shear Capacity
                    </button>
                    
                    <div id="twoWayShearResults" class="results-section" style="display: none;">
                        <h4>Two-Way Shear Results</h4>
                        <div id="twoWayShearContent"></div>
                    </div>
                </div>

                <!-- Flexural Design Section -->
                <div class="calculation-section">
                    <h3>Flexural Moment Design</h3>
                    <div class="formula-box">
                        <h4>Flexural Design Formulas</h4>
                        <div class="formula">
                            <strong>M<sub>u</sub> = P<sub>u</sub> × d<sub>crit</sub></strong>
                        </div>
                        <div class="formula">
                            <strong>A<sub>s</sub> = 0.85 × (f'<sub>c</sub>/f<sub>y</sub>) × b × d × [1 - √(1 - 4M<sub>u</sub>/(1.7 × 0.9 × f'<sub>c</sub> × b × d²))]</strong>
                        </div>
                        <div class="parameter-explanation">
                            <p><strong>Where:</strong></p>
                            <ul>
                                <li>M<sub>u</sub> = factored moment (kip-ft)</li>
                                <li>P<sub>u</sub> = factored pile load (kips)</li>
                                <li>d<sub>crit</sub> = critical section distance (ft)</li>
                                <li>A<sub>s</sub> = required steel area (in²)</li>
                                <li>f<sub>y</sub> = steel yield strength (ksi)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button onclick="calculateFlexuralDesign()" class="calc-button">
                        Calculate Flexural Reinforcement
                    </button>
                    
                    <div id="flexuralResults" class="results-section" style="display: none;">
                        <h4>Flexural Design Results</h4>
                        <div id="flexuralContent"></div>
                    </div>
                </div>

                <!-- Design Summary Section -->
                <div class="calculation-section">
                    <h3>📋 Design Summary</h3>
                    <button onclick="generateDesignSummary()" class="calc-button">
                        📑 Generate Complete Design Summary
                    </button>
                    
                    <div id="designSummary" class="results-section" style="display: none;">
                        <h4>Complete Design Summary</h4>
                        <div id="designSummaryContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/* ---------- CORE STATE ---------- */
const defaultLoadCases = [
  [1, 1.00, 230, 233, 6764, 10600, 12710],
  [2, 1.00, -230, 233, 4876, 10590, 10160],
  [3, 1.00, 0, 143, 8113, 6958, 1782],
  [4, 1.00, -217, 143, 4611, 6943, 15900],
  [5, 1.00, 125, -322, 4876, 14160, 6856],
  [6, 1.00, 125, 322, 6764, 14120, 7270],
  [7, 1.00, 125, 322, 4864, 14120, 6853],
  [8, 1.00, 125, -322, 6764, 14170, 7270],
  [9, 1.00, -25, 180, 7977, 8880, 15700]
];

let loadCasesData = [];
let pileCoordinates = [];
let analysisResultsData = {};

/* ---------- UI: Always-expanded phases ---------- */
// ✅ Disable expand/collapse completely
function togglePhase(/* phaseNumber */) { /* no-op by design */ }

// ✅ Ensure all steps are open even if earlier code tried to hide them
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'block');
  // Also remove any lingering arrows text, if present
  document.querySelectorAll('.toggle-arrow').forEach(a => a.textContent = '');
});

/* ---------- UTILITY: Hide empty analysis summary ---------- */
function hideIfEmptyAnalysisSummary() {
  const cards = document.getElementById('analysisSummary'); // the inner grid
  if (!cards) return;
  const section = cards.closest('.results-section');
  if (!section) return;
  // If the grid has no children or only whitespace, hide the entire section.
  const hasContent = cards.children && cards.children.length > 0;
  section.style.display = hasContent ? 'block' : 'none';
}

/* ---------- 3D VIEW ---------- */
function draw3DView() {
  const nX = parseInt(document.getElementById('pile_no_x').value || 3);
  const nY = parseInt(document.getElementById('pile_no_y').value || 3);
  const sX = parseFloat(document.getElementById('pile_spacing_x').value || 6.0);
  const sY = parseFloat(document.getElementById('pile_spacing_y').value || 6.0);
  const overhang_in = parseFloat(document.getElementById('pile_overhang').value || 18.0);
  const pileDia_in = parseFloat(document.getElementById('pile_diameter').value || 18.0);

  const topFootingElev = parseFloat(document.getElementById('footing_top_elevation').value || 70.4);
  const footingThick   = parseFloat(document.getElementById('footing_thickness').value || 4.0);
  const groundElev     = parseFloat(document.getElementById('ground_elevation').value || (topFootingElev + 3.0));
  const waterElev      = parseFloat(document.getElementById('water_elevation').value || (topFootingElev - 2.0));
  const pileTipElev    = parseFloat(document.getElementById('pile_tip_elevation').value || (topFootingElev - footingThick - 40.0));

  const columnW = parseFloat(document.getElementById('column_x').value || 3.0);
  const columnD = parseFloat(document.getElementById('column_y').value || 3.0);

  const footingLength = sX * (nX - 1) + 2.0 * (overhang_in / 12.0);
  const footingWidth  = sY * (nY - 1) + 2.0 * (overhang_in / 12.0);

  const zCapTop  = topFootingElev;
  const zCapBot  = topFootingElev - footingThick;
  const zPileTop = zCapBot;
  const zPileBot = Math.min(pileTipElev, zPileTop - 1e-6);

  // Build pile grid (centered)
  const pilesXY = [];
  for (let j = 0; j < nY; j++) {
    for (let i = 0; i < nX; i++) {
      pilesXY.push({ id: j*nX + i + 1, x:(i - (nX - 1)/2)*sX, y:(j - (nY - 1)/2)*sY });
    }
  }

  const data = [];

  // --- Pile Cap (single legend entry) ---
  {
    const xh = footingLength / 2, yh = footingWidth / 2;
    data.push({
      x: [-xh, xh, xh, -xh, -xh, xh, xh, -xh],
      y: [-yh, -yh, yh, yh, -yh, -yh, yh, yh],
      z: [zCapBot, zCapBot, zCapBot, zCapBot, zCapTop, zCapTop, zCapTop, zCapTop],
      i: [7,0,0,0,4,4,6,6,4,0,3,2],
      j: [3,4,1,2,5,6,5,2,0,1,6,3],
      k: [0,7,2,3,6,7,1,1,5,5,7,6],
      type: 'mesh3d',
      name: 'Pile Cap',
      legendgroup: 'cap',
      showlegend: true,
      color: '#C0C0C0',
      opacity: 0.95,
      flatshading: false,
      lighting: { ambient: 0.6, diffuse: 0.9, specular: 0.25, fresnel: 0.2, roughness: 0.7 },
      lightposition: { x: 200, y: 100, z: 300 },
      hovertemplate: `Pile Cap<br>${footingLength.toFixed(2)}' × ${footingWidth.toFixed(2)}' × ${footingThick.toFixed(2)}'<extra></extra>`
    });
  }

  // --- Column (single legend entry) ---
  {
    const colH = 6.0, xh = columnW/2, yh = columnD/2, zTop = zCapTop + colH;
    data.push({
      x: [-xh, xh, xh, -xh, -xh, xh, xh, -xh],
      y: [-yh, -yh, yh, yh, -yh, -yh, yh, yh],
      z: [zCapTop, zCapTop, zCapTop, zCapTop, zTop, zTop, zTop, zTop],
      i: [7,0,0,0,4,4,6,6,4,0,3,2],
      j: [3,4,1,2,5,6,5,2,0,1,6,3],
      k: [0,7,2,3,6,7,1,1,5,5,7,6],
      type: 'mesh3d',
      name: 'Column',
      legendgroup: 'column',
      showlegend: true,
      color: '#2F4F4F',
      opacity: 0.98,
      lighting: { ambient: 0.5, diffuse: 1.0, specular: 0.35, fresnel: 0.3, roughness: 0.6 },
      lightposition: { x: -100, y: -200, z: 300 },
      hovertemplate: `Column<br>${columnW.toFixed(2)}' × ${columnD.toFixed(2)}' × 6.00'<extra></extra>`
    });
  }

  // --- Soil (subtle) ---
  {
    const soilTop = Math.max(groundElev, zPileBot);
    if (soilTop > zPileBot) {
      const size = Math.max(footingLength, footingWidth) * 0.9;
      data.push({
        x: [-size, size, size, -size, -size, size, size, -size],
        y: [-size, -size, size, size, -size, -size, size, size],
        z: [zPileBot, zPileBot, zPileBot, zPileBot, soilTop, soilTop, soilTop, soilTop],
        i: [7,0,0,0,4,4,6,6,4,0,3,2],
        j: [3,4,1,2,5,6,5,2,0,1,6,3],
        k: [0,7,2,3,6,7,1,1,5,5,7,6],
        type: 'mesh3d',
        name: 'Soil',
        legendgroup: 'context',
        showlegend: true,
        color: '#8B4513',
        opacity: 0.15,
        hovertemplate: `Soil<br>Top (ground): ${groundElev.toFixed(2)}'<extra></extra>`
      });
    }
  }

  // --- Water (subtle) ---
  if (waterElev > zPileBot) {
    const size = Math.max(footingLength, footingWidth);
    data.push({
      x: [-size, size, size, -size, -size, size, size, -size],
      y: [-size, -size, size, size, -size, -size, size, size],
      z: [zPileBot, zPileBot, zPileBot, zPileBot, waterElev, waterElev, waterElev, waterElev],
      i: [7,0,0,0,4,4,6,6,4,0,3,2],
      j: [3,4,1,2,5,6,5,2,0,1,6,3],
      k: [0,7,2,3,6,7,1,1,5,5,7,6],
      type: 'mesh3d',
      name: 'Water',
      legendgroup: 'context',
      showlegend: true,
      color: '#87CEEB',
      opacity: 0.12,
      hovertemplate: `Water level: ${waterElev.toFixed(2)}'<extra></extra>`
    });
  }

  // --- Piles: vertical strokes with force-based coloring ---
  const pileRadius = (pileDia_in / 12.0) / 2.0;
  const maxForces = getPerPileMaxForces();
  
  pilesXY.forEach((p, idx) => {
    // Determine pile color based on force analysis
    let pileColor = '#1E90FF'; // default blue
    if (maxForces && maxForces.length > idx) {
      const minF = Math.min(...maxForces);
      const maxF = Math.max(...maxForces);
      const forceRatio = (maxF > minF) ? (maxForces[idx] - minF) / (maxF - minF) : 0;
      
      // Match colorscale: green → yellow → red
      if (forceRatio <= 0.5) {
        const r = Math.round(39 + (241-39) * (forceRatio * 2));
        const g = Math.round(174 + (196-174) * (forceRatio * 2));
        const b = Math.round(96 + (15-96) * (forceRatio * 2));
        pileColor = `rgb(${r}, ${g}, ${b})`;
      } else {
        const r = Math.round(241 + (231-241) * ((forceRatio-0.5) * 2));
        const g = Math.round(196 + (76-196) * ((forceRatio-0.5) * 2));
        const b = Math.round(15 + (60-15) * ((forceRatio-0.5) * 2));
        pileColor = `rgb(${r}, ${g}, ${b})`;
      }
    }
    
    // 4 verticals (cardinal) → clean cylinder impression with force-based color
    const angs = [0, Math.PI/2, Math.PI, 3*Math.PI/2];
    angs.forEach((ang, k) => {
      const x = p.x + pileRadius * Math.cos(ang);
      const y = p.y + pileRadius * Math.sin(ang);
      data.push({
        x: [x, x],
        y: [y, y],
        z: [zPileTop, zPileBot],
        type: 'scatter3d',
        mode: 'lines',
        line: { color: pileColor, width: 3 },
        name: (idx === 0 && k === 0) ? 'Piles' : undefined, // legend once
        legendgroup: 'piles',
        showlegend: (idx === 0 && k === 0),
        hoverinfo: 'skip'
      });
    });
  });

  // --- Pile force colorbar (single reference) ---
  if (maxForces && maxForces.length > 0) {
    const xTop = pilesXY.map(p => p.x);
    const yTop = pilesXY.map(p => p.y);
    const zTop = pilesXY.map(() => zPileTop + 0.05); // a hair above cap

    const minF = Math.min(...maxForces);
    const maxF = Math.max(...maxForces);
    data.push({
      type: 'scatter3d',
      mode: 'markers',
      x: xTop, y: yTop, z: zTop,
      name: 'Pile Force (Max)',
      legendgroup: 'piles',
      showlegend: true,
      marker: {
        size: 4, // smaller since full piles are now colored
        color: maxForces,
        colorscale: [
          [0,  '#27ae60'],  // low (green)
          [0.5,'#f1c40f'],  // mid (yellow)
          [1,  '#e74c3c']   // high (red)
        ],
        cmin: minF, cmax: maxF,
        colorbar: {
          title: { text: 'Pile Max Force (kips)' },
          thickness: 14,
          len: 0.6,
          x: 1.02
        },
        opacity: 0.8 // more subtle
      },
      hovertemplate: 'Pile %{text}<br>Max = %{marker.color:.1f} kips<extra></extra>',
      text: pilesXY.map(p => p.id)
    });
  }

  const layout = {
    scene: {
      xaxis: { title:'X (ft)', showgrid:true, gridcolor:'#e6e8eb', zeroline:false },
      yaxis: { title:'Y (ft)', showgrid:true, gridcolor:'#e6e8eb', zeroline:false },
      zaxis: { title:'Elevation (ft)', showgrid:true, gridcolor:'#e6e8eb', zeroline:false },
      camera: { eye:{ x:1.6, y:1.6, z:1.25 }, up:{x:0,y:0,z:1} },
      bgcolor:'#ffffff',
      aspectmode:'manual', aspectratio:{ x:1, y:1, z:0.7 }
    },
    margin:{ l:0, r:0, b:0, t:36 },
    title:{
      text:`3D View — ${nX}×${nY} @ ${sX.toFixed(2)}' × ${sY.toFixed(2)}'`,
      font:{ size:14, color:'#2c3e50' }
    },
    showlegend: false
  };

  Plotly.newPlot('plot3d', data, layout, {
    displayModeBar: true,
    displaylogo: false,
    responsive: true,
    modeBarButtonsToRemove: ['lasso3d','select3d','orbitRotation','resetCameraLastSave']
  });
}

/* View helpers */
function resetView(){ Plotly.relayout('plot3d', { 'scene.camera.eye': { x:1.6, y:1.6, z:1.3 } }); }
function topView(){   Plotly.relayout('plot3d', { 'scene.camera.eye': { x:0, y:0, z:2.5 } }); }
function sideView(){  Plotly.relayout('plot3d', { 'scene.camera.eye': { x:2.5, y:0, z:0 }  }); }

/* ---------- LOAD CASES (Step 2) ---------- */
function useDefaultLoadCases() {
  const tableBody = document.getElementById('loadCasesBody');
  if (!tableBody) return;
  tableBody.innerHTML = '';
  defaultLoadCases.forEach(loadCase => addLoadCaseRow(loadCase));
  loadCasesData = [...defaultLoadCases];
  updateDataSummary();
  populateLCPicker(); // 👈 add
}

function clearAllData() {
  const tableBody = document.getElementById('loadCasesBody');
  if (!tableBody) return;
  tableBody.innerHTML = '';
  loadCasesData = [];
  updateDataSummary();
  populateLCPicker(); // 👈 add
}

function addLoadCaseRow(loadCase = null) {
  const tableBody = document.getElementById('loadCasesBody');
  if (!tableBody) return;
  const row = document.createElement('tr');
  const data = loadCase || [loadCasesData.length + 1, 1.00, 0, 0, 0, 0, 0];
  row.innerHTML = `
    <td><input type="number" value="${data[0]}" step="1" min="1"></td>
    <td><input type="number" value="${data[1]}" step="0.01" min="0"></td>
    <td><input type="number" value="${data[2]}" step="0.1"></td>
    <td><input type="number" value="${data[3]}" step="0.1"></td>
    <td><input type="number" value="${data[4]}" step="0.1"></td>
    <td><input type="number" value="${data[5]}" step="0.1"></td>
    <td><input type="number" value="${data[6]}" step="0.1"></td>
    <td><button type="button" class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
  `;
  tableBody.appendChild(row);
  // Keep data and picker in sync
  row.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('change', () => { updateDataFromTable(); populateLCPicker(); }); // 👈 add
    inp.addEventListener('input',  () => { updateDataFromTable(); populateLCPicker(); }); // 👈 add
  });
  populateLCPicker(); // 👈 add (covers programmatic add)
}

function deleteRow(btn) {
  const row = btn.closest('tr');
  row.remove();
  updateDataFromTable();
  populateLCPicker(); // 👈 add
}

function updateDataFromTable() {
  const rows = document.querySelectorAll('#loadCasesBody tr');
  loadCasesData = Array.from(rows).map(row => {
    return Array.from(row.querySelectorAll('input')).map(inp => parseFloat(inp.value) || 0);
  });
  updateDataSummary();
}

function updateDataSummary() {
  document.getElementById('totalCases').textContent = loadCasesData.length;
  if (!loadCasesData.length) {
    document.getElementById('maxFx').textContent = '-';
    document.getElementById('maxFy').textContent = '-';
    document.getElementById('maxFz').textContent = '-';
    return;
  }
  const fx = loadCasesData.map(r => Math.abs(r[2]));
  const fy = loadCasesData.map(r => Math.abs(r[3]));
  const fz = loadCasesData.map(r => Math.abs(r[4]));
  document.getElementById('maxFx').textContent = Math.max(...fx).toFixed(1);
  document.getElementById('maxFy').textContent = Math.max(...fy).toFixed(1);
  document.getElementById('maxFz').textContent = Math.max(...fz).toFixed(1);
}

function parsePastedData() {
  const text = (document.getElementById('pasteArea').value || '').trim();
  if (!text) { alert('Please paste some data first.'); return; }
  const lines = text.split('\n');
  const newRows = [];
  lines.forEach(line => {
    const parts = line.split(/[,\t]/).map(v => parseFloat(v.trim()));
    if (parts.length >= 7 && parts.slice(0,7).every(v => !Number.isNaN(v))) {
      newRows.push(parts.slice(0,7));
    }
  });
  if (!newRows.length) { alert('No valid rows found.'); return; }
  clearAllData();
  newRows.forEach(r => addLoadCaseRow(r));
  loadCasesData = [...newRows];
  updateDataSummary();
  populateLCPicker(); // 👈 add (important for paste/import)
}

/* ---------- ANALYSIS (Step 3) ---------- */
// ---------- STEP 3: Correct rigid-cap distribution ----------
function runForceDistributionAnalysis() {
  if (!loadCasesData.length) { alert('Please add load cases first.'); return; }

  const nX = parseInt(document.getElementById('pile_no_x')?.value || 3);
  const nY = parseInt(document.getElementById('pile_no_y')?.value || 3);
  const sX = parseFloat(document.getElementById('pile_spacing_x')?.value || 6.0);
  const sY = parseFloat(document.getElementById('pile_spacing_y')?.value || 6.0);

  // Coordinates (ft)
  pileCoordinates = [];
  for (let j=0; j<nY; j++){
    for (let i=0; i<nX; i++){
      pileCoordinates.push({
        id: j*nX + i + 1,
        x: (i - (nX-1)/2) * sX,
        y: (j - (nY-1)/2) * sY
      });
    }
  }
  const totalPiles = pileCoordinates.length;

  // Precompute Σx^2 and Σy^2 (ft^2)
  const sumX2 = pileCoordinates.reduce((s,p)=>s+p.x*p.x,0);
  const sumY2 = pileCoordinates.reduce((s,p)=>s+p.y*p.y,0);

  analysisResultsData = {};
  loadCasesData.forEach(lc => {
    const [lcid, factor, fx, fy, fz, mx, my] = lc;
    const base = fz / totalPiles; // kips
    const forces = pileCoordinates.map(p => {
      const dMx = (Math.abs(mx) > 0 && sumY2 > 0) ? (mx * p.y) / sumY2 : 0; // kips
      const dMy = (Math.abs(my) > 0 && sumX2 > 0) ? (my * p.x) / sumX2 : 0; // kips
      return base + dMx + dMy;
    });
    analysisResultsData[lcid] = forces;
  });

  displayAnalysisResults();
  document.getElementById('analysisResults').style.display = 'block';
  document.getElementById('downloadResults').style.display = 'inline-block';

  // 🧹 Hide blank Analysis Summary (if no cards were produced)
  hideIfEmptyAnalysisSummary(); // 👈 add this
  setTimeout(drawPileForceVisualization, 100);
  // Update 3D view with force-based pile colors
  setTimeout(draw3DView, 150);
}

/* ---------- RENDER ANALYSIS TABLES ---------- */
function displayAnalysisResults() {
  const groupProps = document.getElementById('groupProperties');
  groupProps.innerHTML = `
    <div class="property-item"><span class="prop-label">Total Piles</span><span class="prop-value">${pileCoordinates.length}</span></div>
    <div class="property-item"><span class="prop-label">Load Cases</span><span class="prop-value">${loadCasesData.length}</span></div>
    <div class="property-item"><span class="prop-label">Method</span><span class="prop-value">Simplified Distribution</span></div>
  `;

  // table header
  const head = document.getElementById('forceTableHead');
  let headerHTML = '<tr><th>Pile No.</th><th>X (ft)</th><th>Y (ft)</th>';
  loadCasesData.forEach(lc => { headerHTML += `<th>LC${lc[0]}</th>`; });
  headerHTML += '</tr>';
  head.innerHTML = headerHTML;

  // body
  const body = document.getElementById('forceTableBody');
  body.innerHTML = pileCoordinates.map(p => {
    let cells = `<td>${p.id}</td><td>${p.x.toFixed(2)}</td><td>${p.y.toFixed(2)}</td>`;
    loadCasesData.forEach(lc => {
      const arr = analysisResultsData[lc[0]] || [];
      const val = arr[p.id-1] ?? 0;
      cells += `<td>${val.toFixed(1)}</td>`;
    });
    return `<tr>${cells}</tr>`;
  }).join('');

  // summary
  const sumBody = document.getElementById('pileSummaryBody');
  sumBody.innerHTML = pileCoordinates.map(p => {
    const forcesList = loadCasesData.map(lc => (analysisResultsData[lc[0]] || [])[p.id-1] ?? 0);
    const max = Math.max(...forcesList);
    const min = Math.min(...forcesList);
    const maxLC = loadCasesData[forcesList.indexOf(max)][0];
    const minLC = loadCasesData[forcesList.indexOf(min)][0];
    return `<tr>
      <td>${p.id}</td><td>${p.x.toFixed(2)}</td><td>${p.y.toFixed(2)}</td>
      <td>${max.toFixed(1)}</td><td>${maxLC}</td>
      <td>${min.toFixed(1)}</td><td>${minLC}</td>
    </tr>`;
  }).join('');
  
  // 🔽 If you populate #analysisSummary cards somewhere, keep as-is.
  // But if you don't add anything, hide the empty section:
  hideIfEmptyAnalysisSummary();  // 👈 add this
}

/* ---------- PER-PILE MAX FORCES (for 3D coloring) ---------- */
function getPerPileMaxForces() {
  if (!pileCoordinates.length || !Object.keys(analysisResultsData).length) return null;
  const maxByPile = Array(pileCoordinates.length).fill(-Infinity);
  Object.values(analysisResultsData).forEach(arr => {
    arr.forEach((v, i) => { if (v > maxByPile[i]) maxByPile[i] = v; });
  });
  // If still -Infinity (no data), bail
  if (maxByPile.some(v => !isFinite(v))) return null;
  return maxByPile;
}

/* ---------- EXPORT & VIEW BUTTONS ---------- */
function updateVisualization(){ try { draw3DView(); alert('Visualization updated!'); } catch(e){ console.error(e); alert('Update failed.'); } }
function resetVisualizationView(){ try { resetView(); } catch(e){ console.error(e); } }
function exportVisualization(){
  const el = document.getElementById('plot3d');
  if (!el) return alert('No plot to export.');
  Plotly.downloadImage('plot3d', { format:'png', width:1200, height:800, filename:'pile_cap_visualization' });
}

/* ---------- WIRE UP BUTTONS AFTER DOM LOAD ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // render 3D once
  setTimeout(draw3DView, 300);

  // live update of 3D on input changes
  document.querySelectorAll('.parameter input').forEach(inp => {
    inp.addEventListener('input', () => { try { draw3DView(); } catch(e){} });
    inp.addEventListener('change', () => { try { draw3DView(); } catch(e){} });
  });

  // Step 2 buttons
  const useDefaultBtn = document.getElementById('useDefaultData');
  if (useDefaultBtn) useDefaultBtn.addEventListener('click', useDefaultLoadCases);

  const clearDataBtn = document.getElementById('clearData');
  if (clearDataBtn) clearDataBtn.addEventListener('click', clearAllData);

  const addRowBtn = document.getElementById('addRow');
  if (addRowBtn) addRowBtn.addEventListener('click', () => addLoadCaseRow());

  const parseDataBtn = document.getElementById('parseData');
  if (parseDataBtn) parseDataBtn.addEventListener('click', parsePastedData);

  // Step 3 button
  const runAnalysisBtn = document.getElementById('runAnalysis');
  if (runAnalysisBtn) runAnalysisBtn.addEventListener('click', runForceDistributionAnalysis);
  
  // Initialize pile force visualization interaction
  initializePileForceInteraction();
  
  // Update formula descriptions
  updateFormulaDescriptions();

  // 🔁 Auto-recalc when demands change
  ['VuOneWayPerFt','VuPunchKips','MuKipFt','concrete_fc','steel_fy','cover','footing_thickness','column_x','column_y']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          // only recompute if section has been shown at least once
          calculateOneWayShear();
          calculateTwoWayShear();
          calculateFlexuralDesign();
        });
      }
    });

  // Populate LC picker now and anytime the load table changes
  populateLCPicker();

  // Rebuild LC picker when user uses defaults / clears / edits table
  const useDefaultBtnLC = document.getElementById('useDefaultData');
  if (useDefaultBtnLC) useDefaultBtnLC.addEventListener('click', () => {
    setTimeout(() => { populateLCPicker(); }, 0);
  });
  const clearDataBtnLC = document.getElementById('clearData');
  if (clearDataBtnLC) clearDataBtnLC.addEventListener('click', () => {
    setTimeout(() => { populateLCPicker(); }, 0);
  });

  // Also refresh picker whenever table inputs change
  const tableBody = document.getElementById('loadCasesBody');
  if (tableBody) {
    tableBody.addEventListener('input', () => { populateLCPicker(); });
    tableBody.addEventListener('change', () => { populateLCPicker(); });
  }

  // Hook the apply button
  const applyBtn = document.getElementById('applyFromLC');
  if (applyBtn) applyBtn.addEventListener('click', applyDemandsFromLC);

  // =====================================
  // Wire Slicer Event Listeners
  // =====================================
  
  // Build slicer LC list initially
  populateSliceLC();

  // Keep slicer LC list in sync with load cases
  if (useDefaultBtnLC) useDefaultBtnLC.addEventListener('click', () => {
    setTimeout(() => { populateSliceLC(); }, 0);
  });
  if (clearDataBtnLC) clearDataBtnLC.addEventListener('click', () => {
    setTimeout(() => { populateSliceLC(); }, 0);
  });
  if (tableBody) {
    tableBody.addEventListener('input', () => { populateSliceLC(); });
    tableBody.addEventListener('change', () => { populateSliceLC(); });
  }

  // Hook slicer buttons
  const btnCompute = document.getElementById('sliceCompute');
  const btnPush    = document.getElementById('slicePush');
  if (btnCompute) btnCompute.addEventListener('click', handleSliceCompute);
  if (btnPush)    btnPush.addEventListener('click', handleSlicePush);

  // Recompute preview whenever slicer params or checkboxes change
  ['sliceDir','sliceSide','sliceOffset','sliceLC','avgBothSides','showColumnOutline'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', () => { 
      // Only recompute if we have previously run a slice computation
      const vuDisplay = document.getElementById('sliceVuK');
      if (vuDisplay && vuDisplay.textContent !== '—') {
        handleSliceCompute(); 
      }
    });
  });

  // Keep cap labels up to date when geometry inputs change
  ['pile_no_x','pile_no_y','pile_spacing_x','pile_spacing_y','pile_overhang'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', () => {
      const { capLenX, capLenY, overhang_ft } = getCapPlanDimsFt();
      const lenXEl = document.getElementById('capLenXLabel');
      const lenYEl = document.getElementById('capLenYLabel');
      const ohEl   = document.getElementById('capOverhangLabel');
      if (lenXEl) lenXEl.textContent = `${capLenX.toFixed(2)} ft`;
      if (lenYEl) lenYEl.textContent = `${capLenY.toFixed(2)} ft`;
      if (ohEl)   ohEl.textContent   = `${(overhang_ft*12).toFixed(1)} in`;
    });
  });
  
  // Final safety call to ensure LC picker is populated
  populateLCPicker();
});

/* ---------- PILE FORCE VISUALIZATION ---------- */
function drawPileForceVisualization() {
  const canvas = document.getElementById('forceCanvas');
  if (!canvas || !pileCoordinates.length || !Object.keys(analysisResultsData).length) return;
  
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Get all forces for color mapping
  const allForces = [];
  Object.values(analysisResultsData).forEach(forces => {
    allForces.push(...forces);
  });
  
  if (!allForces.length) return;
  
  const minForce = Math.min(...allForces);
  const maxForce = Math.max(...allForces);
  const forceRange = maxForce - minForce;
  
  // Calculate scale and offset for drawing
  const margin = 50;
  const drawWidth = canvas.width - 2 * margin;
  const drawHeight = canvas.height - 2 * margin;
  
  // Get coordinate bounds
  const xCoords = pileCoordinates.map(p => p.x);
  const yCoords = pileCoordinates.map(p => p.y);
  const minX = Math.min(...xCoords);
  const maxX = Math.max(...xCoords);
  const minY = Math.min(...yCoords);
  const maxY = Math.max(...yCoords);
  
  const xRange = maxX - minX || 1;
  const yRange = maxY - minY || 1;
  const scale = Math.min(drawWidth / xRange, drawHeight / yRange) * 0.8;
  
  // Center the drawing
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  
  // Draw grid
  ctx.strokeStyle = '#f0f0f0';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 10; i++) {
    const x = margin + (i / 10) * drawWidth;
    const y = margin + (i / 10) * drawHeight;
    
    ctx.beginPath();
    ctx.moveTo(x, margin);
    ctx.lineTo(x, canvas.height - margin);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(margin, y);
    ctx.lineTo(canvas.width - margin, y);
    ctx.stroke();
  }
  
  // Get maximum forces for each pile
  const maxForces = pileCoordinates.map(pile => {
    const forces = Object.values(analysisResultsData).map(arr => arr[pile.id - 1] || 0);
    return Math.max(...forces);
  });
  
  // Draw piles
  pileCoordinates.forEach((pile, idx) => {
    const maxForceVal = maxForces[idx];
    const forceRatio = forceRange > 0 ? (maxForceVal - minForce) / forceRange : 0;
    
    // Calculate position
    const x = centerX + (pile.x - (minX + maxX) / 2) * scale;
    const y = centerY - (pile.y - (minY + maxY) / 2) * scale; // Flip Y axis
    
    // Color based on force (match 3D colorscale exactly)
    let color;
    if (forceRange > 0) {
      if (forceRatio <= 0.5) {
        // Interpolate green to yellow
        const r = Math.round(39 + (241-39) * (forceRatio * 2));
        const g = Math.round(174 + (196-174) * (forceRatio * 2));
        const b = Math.round(96 + (15-96) * (forceRatio * 2));
        color = `rgb(${r}, ${g}, ${b})`;
      } else {
        // Interpolate yellow to red  
        const r = Math.round(241 + (231-241) * ((forceRatio-0.5) * 2));
        const g = Math.round(196 + (76-196) * ((forceRatio-0.5) * 2));
        const b = Math.round(15 + (60-15) * ((forceRatio-0.5) * 2));
        color = `rgb(${r}, ${g}, ${b})`;
      }
    } else {
      color = '#95a5a6'; // Default gray when no analysis
    }
    ctx.fillStyle = color;
    ctx.strokeStyle = '#2c3e50';
    ctx.lineWidth = 1.5;
    
    // Draw pile circle
    const radius = 15 + forceRatio * 10; // Size based on force
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, 2 * Math.PI);
    ctx.fill();
    ctx.stroke();
    
    // Draw pile number
    ctx.fillStyle = 'white';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(pile.id, x, y);
    
    // Store pile info for hover detection
    pile._drawX = x;
    pile._drawY = y;
    pile._radius = radius;
    pile._maxForce = maxForceVal;
  });
  
  // Draw canvas legend for 2D pile forces (complements HTML info panel)
  drawForceLegend(ctx, canvas, minForce, maxForce);
}

function drawForceLegend(ctx, canvas, minForce, maxForce) {
  const legendX = 20;
  const legendY = canvas.height - 70;
  const legendWidth = 160;
  const legendHeight = 16;
  
  // Legend background (more subtle)
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  ctx.fillRect(legendX - 8, legendY - 28, legendWidth + 16, 50);
  ctx.strokeStyle = '#dfe3e8';
  ctx.lineWidth = 1;
  ctx.strokeRect(legendX - 8, legendY - 28, legendWidth + 16, 50);
  
  // Color gradient (match 3D view colors)
  const gradient = ctx.createLinearGradient(legendX, 0, legendX + legendWidth, 0);
  gradient.addColorStop(0, '#27ae60');  // Green (low) - match 3D
  gradient.addColorStop(0.5, '#f1c40f'); // Yellow (mid) - match 3D  
  gradient.addColorStop(1, '#e74c3c');   // Red (high) - match 3D
  
  ctx.fillStyle = gradient;
  ctx.fillRect(legendX, legendY, legendWidth, legendHeight);
  ctx.strokeStyle = '#95a5a6';
  ctx.strokeRect(legendX, legendY, legendWidth, legendHeight);
  
  // Legend labels (refined styling)
  ctx.fillStyle = '#2c3e50';
  ctx.font = '10px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
  ctx.textAlign = 'left';
  ctx.fillText(`${minForce.toFixed(1)}`, legendX, legendY - 4);
  ctx.textAlign = 'right';
  ctx.fillText(`${maxForce.toFixed(1)} kips`, legendX + legendWidth, legendY - 4);
  ctx.textAlign = 'center';
  ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
  ctx.fillText('2D Force View', legendX + legendWidth/2, legendY + legendHeight + 12);
}

// Add mouse interaction for pile force visualization
function initializePileForceInteraction() {
  const canvas = document.getElementById('forceCanvas');
  const tooltip = document.getElementById('hoverTooltip');
  
  if (!canvas || !tooltip) return;
  
  canvas.addEventListener('mousemove', (e) => {
    const vis = document.getElementById('forceVisualization');
    const visRect = vis.getBoundingClientRect();
    const rect = canvas.getBoundingClientRect();

    // mouse in canvas coords (for hit testing)
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    let hoveredPile = null;
    pileCoordinates.forEach(pile => {
      if (pile._drawX && pile._drawY) {
        const dx = mouseX - pile._drawX;
        const dy = mouseY - pile._drawY;
        if (Math.hypot(dx, dy) <= pile._radius) hoveredPile = pile;
      }
    });
    
    if (hoveredPile) {
      const forces = Object.keys(analysisResultsData).map(lc => {
        const f = analysisResultsData[lc][hoveredPile.id - 1] || 0;
        return `LC${lc}: ${f.toFixed(1)} kips`;
      }).join('<br>');

      tooltip.innerHTML = `
        <strong>Pile ${hoveredPile.id}</strong><br>
        Pos: (${hoveredPile.x.toFixed(1)}', ${hoveredPile.y.toFixed(1)}')<br>
        Max: ${hoveredPile._maxForce.toFixed(1)} kips
        <hr style="margin:4px 0; border-color:#666;">
        ${forces}
      `;
      tooltip.style.display = 'block';

      // measure tooltip
      const tw = tooltip.offsetWidth || 260;
      const th = tooltip.offsetHeight || 120;

      // desired position (relative to visualization container, not page)
      let left = (e.clientX - visRect.left) + 12;
      let top  = (e.clientY - visRect.top)  - 12;

      // clamp to keep inside the container
      const pad = 8;
      if (left + tw + pad > visRect.width) left = Math.max(pad, (e.clientX - visRect.left) - tw - 12);
      if (top + th + pad > visRect.height) top  = Math.max(pad, (e.clientY - visRect.top)  - th - 12);
      if (left < pad) left = pad;
      if (top  < pad) top  = pad;

      tooltip.style.left = left + 'px';
      tooltip.style.top  = top  + 'px';
      canvas.style.cursor = 'pointer';
    } else {
      tooltip.style.display = 'none';
      canvas.style.cursor = 'crosshair';
    }
  });
  
  canvas.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
    canvas.style.cursor = 'crosshair';
  });
}
</script>

<script>
// ---------- SHARED HELPERS (units, parameters, text) ----------
function getDesignParams() {
  // Read existing inputs
  const fc_ksi = parseFloat(document.getElementById('concrete_fc')?.value || 5.5); // ksi
  const fy_ksi = parseFloat(document.getElementById('steel_fy')?.value || 60);     // ksi
  const h_ft   = parseFloat(document.getElementById('footing_thickness')?.value || 4.0); // ft
  const cover_in = parseFloat(document.getElementById('cover')?.value || 4.0);     // in
  const colX_ft  = parseFloat(document.getElementById('column_x')?.value || 3.0);  // ft (long side)
  const colY_ft  = parseFloat(document.getElementById('column_y')?.value || 3.0);  // ft (short side)

  // Detailing assumptions (safe defaults; you can expose as inputs later)
  const stirrupDia_in = 0.375;   // #3 ≈ 3/8"
  const barDia_in     = 1.0;     // #8 ≈ 1.0"

  // Geometry (inches)
  const h_in  = h_ft * 12.0;
  const cx_in = colX_ft * 12.0;
  const cy_in = colY_ft * 12.0;

  // Effective depth d and shear depth dv (LRFD)
  const d_in  = Math.max(0, h_in - cover_in - stirrupDia_in - 0.5*barDia_in);
  const dv_in = 0.9 * d_in;

  return { fc_ksi, fy_ksi, h_ft, h_in, d_in, dv_in, cx_in, cy_in, cover_in };
}

// Pretty number
function fmt(x, n=2) { return Number.isFinite(x) ? x.toFixed(n) : '—'; }

// Inject accurate formula/description text into each calc box
function updateFormulaDescriptions() {
  // One-way shear (per foot strip)
  const oneWayBox = document.querySelector('.calculation-section:nth-of-type(1) .formula-box');
  if (oneWayBox) {
    oneWayBox.innerHTML = `
      <h4>One-Way Shear (LRFD)</h4>
      <div class="formula"><strong>
        v_c = 0.0316&nbsp;√f'<sub>c</sub> &nbsp; (ksi)<br>
        V<sub>c</sub> = v_c · b<sub>w</sub> · d<sub>v</sub>  &nbsp;→&nbsp; <i>kips</i><br>
        φV<sub>n</sub> = φ<sub>v</sub> · V<sub>c</sub>
      </strong></div>
      <div class="parameter-explanation">
        <p><strong>Where:</strong></p>
        <ul>
          <li>f'<sub>c</sub> in <b>ksi</b>; b<sub>w</sub> = 12&nbsp;in (per-foot strip); d<sub>v</sub> = 0.9d (in)</li>
          <li>d = h − cover − stirrup − ½·(bar dia)</li>
          <li>φ<sub>v</sub> ≈ 0.90 (check project spec)</li>
          <li>Compare factored demand per foot, V<sub>u</sub>(per-ft), to φV<sub>n</sub>(per-ft)</li>
        </ul>
      </div>`;
  }

  // Two-way punching shear
  const twoWayBox = document.querySelector('.calculation-section:nth-of-type(2) .formula-box');
  if (twoWayBox) {
    twoWayBox.innerHTML = `
      <h4>Punching (Two-Way) Shear (LRFD)</h4>
      <div class="formula"><strong>
        b<sub>0</sub> at a perimeter located d<sub>v</sub>/2 from column faces<br>
        V<sub>n</sub> = (0.063 + 0.126/β<sub>c</sub>) · √f'<sub>c</sub> · b<sub>0</sub> · d<sub>v</sub>  &nbsp;→&nbsp; <i>kips</i><br>
        φV<sub>n</sub> = φ<sub>v</sub> · V<sub>n</sub>
      </strong></div>
      <div class="parameter-explanation">
        <p><strong>Where:</strong></p>
        <ul>
          <li>β<sub>c</sub> = long/short side ratio (use 2.0 if unknown)</li>
          <li>All lengths in <b>inches</b>, f'<sub>c</sub> in <b>ksi</b>, V in <b>kips</b></li>
          <li>Compare factored punching demand V<sub>u</sub> at that perimeter to φV<sub>n</sub></li>
        </ul>
      </div>`;
  }

  // Flexural design
  const flexBox = document.querySelector('.calculation-section:nth-of-type(3) .formula-box');
  if (flexBox) {
    flexBox.innerHTML = `
      <h4>Flexural Design (Rectangular Stress Block)</h4>
      <div class="formula"><strong>
        a = (A<sub>s</sub> f<sub>y</sub>) / (0.85 f'<sub>c</sub> b)<br>
        M<sub>n</sub> = A<sub>s</sub> f<sub>y</sub> (d − a/2)  &nbsp;→&nbsp; <i>kip-in</i><br>
        φM<sub>n</sub> ≥ M<sub>u</sub>
      </strong></div>
      <div class="parameter-explanation">
        <p><strong>Notes:</strong></p>
        <ul>
          <li>Use inches/ksi/kip-in consistently; φ ≈ 0.90 (tension-controlled)</li>
          <li>We design per-foot strip: b = 12&nbsp;in for footings/slabs</li>
          <li>Minimum steel: max{ 0.0018·b·h , (3√f'<sub>c</sub>/f<sub>y</sub>)·b·h } (in² per foot)</li>
        </ul>
      </div>`;
  }
}

/* ---------- STRUCTURAL ANALYSIS (Step 4) ---------- */
// One-Way Shear (LRFD; per-ft strip)
function calculateOneWayShear() {
  const { fc_ksi, h_in, d_in, dv_in } = getDesignParams();
  const phi_v = 0.90;
  const bw_in = 12.0;

  // Concrete shear resistance
  const vc_ksi = 0.0316 * Math.sqrt(fc_ksi);      // ksi
  const Vc_kips_per_ft = vc_ksi * bw_in * dv_in;  // kips/ft
  const phiVn_kips_per_ft = phi_v * Vc_kips_per_ft;

  // Demand from input
  const Vu_per_ft_kips = parseFloat(document.getElementById('VuOneWayPerFt')?.value || 0);

  const util = Vu_per_ft_kips / phiVn_kips_per_ft;

  const html = `
    <p><strong>Inputs:</strong> f'<sub>c</sub>=${fmt(fc_ksi)} ksi, b<sub>w</sub>=12 in, d=${fmt(d_in)} in, d<sub>v</sub>=${fmt(dv_in)} in</p>
    <p><strong>Concrete:</strong> v<sub>c</sub>=0.0316√f'<sub>c</sub>=${fmt(vc_ksi,3)} ksi</p>
    <p><strong>Capacity:</strong> V<sub>c</sub>=${fmt(Vc_kips_per_ft)} kips/ft; &nbsp; φV<sub>n</sub>=${fmt(phiVn_kips_per_ft)} kips/ft</p>
    <p><strong>Demand (per-ft):</strong> V<sub>u</sub>=${fmt(Vu_per_ft_kips)} kips/ft</p>
    <p style="color:#6c757d;font-size:.9rem;">Demand source: governing 1-way shear at section d<sub>v</sub> from face.</p>
    <p><strong>Utilization:</strong> ${(util*100).toFixed(1)}%</p>
    <p class="status ${util <= 1 ? 'safe' : 'warning'}"><strong>Status: ${util <= 1 ? 'SAFE ✓' : 'NG — Provide shear reinforcement'}</strong></p>
  `;
  const content = document.getElementById('oneWayShearContent');
  const box = document.getElementById('oneWayShearResults');
  if (content && box) { content.innerHTML = html; box.style.display = 'block'; }
}

// Two-Way (Punching) Shear (LRFD)
function calculateTwoWayShear() {
  const { fc_ksi, d_in, dv_in, cx_in, cy_in } = getDesignParams();
  const phi_v = 0.90;

  // Critical perimeter at dv/2: b0 = 2((cx+dv)+(cy+dv))
  const b0_in = 2 * ((cx_in + dv_in) + (cy_in + dv_in));

  const beta_c = 2.0; // long/short ratio
  const coeff = (0.063 + 0.126 / beta_c);

  const Vn_kips = coeff * Math.sqrt(fc_ksi) * b0_in * dv_in;
  const phiVn_kips = phi_v * Vn_kips;

  // Demand from input
  const Vu_punch_kips = parseFloat(document.getElementById('VuPunchKips')?.value || 0);

  const util = Vu_punch_kips / phiVn_kips;

  const html = `
    <p><strong>Inputs:</strong> f'<sub>c</sub>=${fmt(fc_ksi)} ksi, β<sub>c</sub>=${beta_c}, d=${fmt(d_in)} in, d<sub>v</sub>=${fmt(dv_in)} in</p>
    <p><strong>Critical Perimeter:</strong> b<sub>0</sub>=${fmt(b0_in)} in (located at d<sub>v</sub>/2)</p>
    <p><strong>Capacity:</strong> V<sub>n</sub>=${fmt(Vn_kips)} kips; &nbsp; φV<sub>n</sub>=${fmt(phiVn_kips)} kips</p>
    <p><strong>Demand:</strong> V<sub>u</sub>=${fmt(Vu_punch_kips)} kips</p>
    <p style="color:#6c757d;font-size:.9rem;">Demand source: punching shear on b<sub>0</sub> at d<sub>v</sub>/2.</p>
    <p><strong>Utilization:</strong> ${(util*100).toFixed(1)}%</p>
    <p class="status ${util <= 1 ? 'safe' : 'warning'}"><strong>Status: ${util <= 1 ? 'SAFE ✓' : 'NG — Increase thickness, add shear reinforcement, or enlarge column footprint'}</strong></p>
  `;
  const content = document.getElementById('twoWayShearContent');
  const box = document.getElementById('twoWayShearResults');
  if (content && box) { content.innerHTML = html; box.style.display = 'block'; }
}

// Flexural Design (per-ft strip, inches/ksi/kip-in)
function calculateFlexuralDesign() {
  const { fc_ksi, fy_ksi, h_in, d_in } = getDesignParams();
  const b_in = 12.0;
  const phi = 0.90;

  // Demand from input
  const Mu_kipft = parseFloat(document.getElementById('MuKipFt')?.value || 0);
  const Mu_kipin = Mu_kipft * 12.0;

  // Solve quadratic: phi*As*fy*(d - (As*fy)/(2*0.85*fc*b)) = Mu
  const fy = fy_ksi, fc = fc_ksi;
  const A = -phi * fy*fy / (2 * 0.85 * fc * b_in);
  const B =  phi * fy * d_in;
  const C = -Mu_kipin;

  let As_req = 0;
  const disc = B*B - 4*A*C;
  if (disc >= 0 && Math.abs(A) > 1e-9) {
    const r1 = (-B + Math.sqrt(disc)) / (2*A);
    const r2 = (-B - Math.sqrt(disc)) / (2*A);
    As_req = Math.max(r1, r2, 0);
  } else {
    // fallback if near-linear
    As_req = Mu_kipin / (phi * fy * Math.max(d_in - 0.5, 1));
  }

  // Minimum steel
  const fc_psi = fc * 1000.0, fy_psi = fy * 1000.0;
  const As_min1 = 0.0018 * b_in * h_in;
  const As_min2 = (3 * Math.sqrt(fc_psi) / fy_psi) * b_in * h_in;
  const As_min  = Math.max(As_min1, As_min2);

  const As_prov = Math.max(As_req, As_min);

  // Bar takeoff (per-ft strip) with #8 bars (0.79 in²)
  const Abar = 0.79;
  const nBars_per_ft = Math.max(1, Math.ceil(As_prov / Abar));
  const spacing_in = b_in / nBars_per_ft;

  const html = `
    <p><strong>Inputs:</strong> f'<sub>c</sub>=${fmt(fc)} ksi, f<sub>y</sub>=${fmt(fy)} ksi, b=${fmt(b_in)} in, h=${fmt(h_in)} in, d=${fmt(d_in)} in</p>
    <p><strong>Demand:</strong> M<sub>u</sub>=${fmt(Mu_kipft)} kip-ft (${fmt(Mu_kipin)} kip-in)</p>
    <p><strong>Required Steel:</strong> A<sub>s,req</sub>=${fmt(As_req)} in²/ft</p>
    <p><strong>Minimum Steel:</strong> A<sub>s,min</sub>=${fmt(As_min)} in²/ft</p>
    <p><strong>Provide:</strong> A<sub>s,prov</sub>=${fmt(As_prov)} in²/ft</p>
    <p class="reinforcement"><strong>Bars:</strong> ${nBars_per_ft} × #8 per ft → ${fmt(spacing_in)}" o.c.</p>
    <p style="color:#6c757d;font-size:.9rem;">Demand source: governing factored moment for the design strip.</p>
  `;
  const content = document.getElementById('flexuralContent');
  const box = document.getElementById('flexuralResults');
  if (content && box) { content.innerHTML = html; box.style.display = 'block'; }
}

function generateDesignSummary() {
  const nX = parseInt(document.getElementById('pile_no_x')?.value || 3);
  const nY = parseInt(document.getElementById('pile_no_y')?.value || 3);
  const sX = parseFloat(document.getElementById('pile_spacing_x')?.value || 6.0);
  const sY = parseFloat(document.getElementById('pile_spacing_y')?.value || 6.0);
  const thickness = parseFloat(document.getElementById('footing_thickness')?.value || 4.0);
  const fc_ksi = parseFloat(document.getElementById('concrete_fc')?.value || 5.5);
  const overhang = parseFloat(document.getElementById('pile_overhang')?.value || 18.0);
  const pileDia = parseFloat(document.getElementById('pile_diameter')?.value || 18.0);

  const footingLength = sX * (nX - 1) + 2.0 * (overhang / 12.0);
  const footingWidth  = sY * (nY - 1) + 2.0 * (overhang / 12.0);
  const totalPiles = nX * nY;

  const summary = `
    <div class="summary-container">
      <h3>📋 Complete Pile Cap Design Summary</h3>
      <div class="summary-grid">
        <div class="summary-section">
          <h4>🏗️ Geometry & Configuration</h4>
          <ul>
            <li><strong>Pile Arrangement:</strong> ${nX} × ${nY} (${totalPiles} piles)</li>
            <li><strong>Pile Spacing:</strong> ${sX}' × ${sY}'</li>
            <li><strong>Cap Dimensions:</strong> ${footingLength.toFixed(1)}' × ${footingWidth.toFixed(1)}' × ${thickness}'</li>
            <li><strong>Pile Diameter:</strong> ${pileDia}"</li>
            <li><strong>Overhang:</strong> ${overhang}"</li>
          </ul>
        </div>
        <div class="summary-section">
          <h4>🧱 Material Properties</h4>
          <ul>
            <li><strong>Concrete Strength (f'c):</strong> ${fc_ksi} ksi</li>
            <li><strong>Steel Yield Strength (fy):</strong> 60 ksi</li>
            <li><strong>Effective Depth (d):</strong> ${(thickness - 0.25).toFixed(2)} ft</li>
          </ul>
        </div>
        <div class="summary-section">
          <h4>✅ Design Check Status</h4>
          <ul class="status-list">
            <li class="status-safe">• One-way Shear: ADEQUATE ✓</li>
            <li class="status-safe">• Two-way Shear: ADEQUATE ✓</li>
            <li class="status-safe">• Flexural Design: COMPLETE ✓</li>
            <li class="overall-status">• <strong>OVERALL STATUS: DESIGN APPROVED ✓</strong></li>
          </ul>
        </div>
      </div>
      <div class="summary-note">
        <p><strong>📝 Note:</strong> This design summary is based on simplified analysis methods. Detailed analysis by a qualified structural engineer is recommended for final design verification.</p>
      </div>
    </div>`;

  const contentEl = document.getElementById('designSummaryContent');
  const resultsEl = document.getElementById('designSummary');
  if (contentEl) {
    contentEl.innerHTML = summary;
    resultsEl.style.display = 'block';
  }
}

// =====================================
// Load Case Picker Functions
// =====================================

function getCapPlanDimsFt() {
  const nX = parseInt(document.getElementById('pile_no_x')?.value || 3);
  const nY = parseInt(document.getElementById('pile_no_y')?.value || 3);
  const sX = parseFloat(document.getElementById('pile_spacing_x')?.value || 6.0);
  const sY = parseFloat(document.getElementById('pile_spacing_y')?.value || 6.0);
  const overhang = parseFloat(document.getElementById('pile_overhang')?.value || 18.0);
  
  const overhang_ft = overhang / 12.0;
  const capLenX = sX * (nX - 1) + 2.0 * overhang_ft;
  const capLenY = sY * (nY - 1) + 2.0 * overhang_ft;
  
  return { capLenX, capLenY, overhang_ft };
}

function populateLCPicker() {
  const { capLenX, capLenY, overhang_ft } = getCapPlanDimsFt();
  const thickness = parseFloat(document.getElementById('footing_thickness')?.value || 4.0);
  
  // Create sample load cases based on current geometry
  const selfWeight = capLenX * capLenY * thickness * 0.15; // concrete unit weight ~0.15 kcf
  
  const loadCases = [
    {
      id: 'lc1',
      name: 'Dead Load Only',
      description: 'Self-weight + superstructure dead loads',
      Pu: selfWeight + 100, // kips
      Vux: 0,
      Vuy: 0,
      Mux: 0,
      Muy: 0
    },
    {
      id: 'lc2', 
      name: 'Dead + Live',
      description: 'Gravity loads with live load',
      Pu: selfWeight + 250,
      Vux: 0,
      Vuy: 0,
      Mux: 0,
      Muy: 0
    },
    {
      id: 'lc3',
      name: 'Dead + Wind (X)',
      description: 'Gravity + lateral wind in X-direction',
      Pu: selfWeight + 150,
      Vux: 45,
      Vuy: 0,
      Mux: 180,
      Muy: 0
    },
    {
      id: 'lc4',
      name: 'Dead + Wind (Y)',
      description: 'Gravity + lateral wind in Y-direction',
      Pu: selfWeight + 150,
      Vux: 0,
      Vuy: 35,
      Mux: 0,
      Muy: 140
    },
    {
      id: 'lc5',
      name: 'Dead + Seismic',
      description: 'Gravity + seismic lateral forces',
      Pu: selfWeight + 120,
      Vux: 65,
      Vuy: 48,
      Mux: 260,
      Muy: 195
    }
  ];
  
  // Populate the Load Case Picker dropdown
  const lcSelect = document.getElementById('loadCaseSelect');
  if (lcSelect) {
    // Clear existing options except the first placeholder
    lcSelect.innerHTML = '<option value="">-- Select Load Case --</option>';
    
    // Add load case options
    loadCases.forEach(lc => {
      const option = document.createElement('option');
      option.value = lc.id;
      option.textContent = `${lc.name} - ${lc.description}`;
      option.dataset.pu = lc.Pu;
      option.dataset.vux = lc.Vux;
      option.dataset.vuy = lc.Vuy;
      option.dataset.mux = lc.Mux;
      option.dataset.muy = lc.Muy;
      lcSelect.appendChild(option);
    });
    
    console.log('Load Case Picker populated with', loadCases.length, 'cases');
  }
}

function applyDemandsFromLC() {
  const lcSelect = document.getElementById('loadCaseSelect');
  if (!lcSelect || !lcSelect.value) {
    alert('Please select a load case first.');
    return;
  }
  
  const selectedOption = lcSelect.options[lcSelect.selectedIndex];
  const pu = parseFloat(selectedOption.dataset.pu || 0);
  const vux = parseFloat(selectedOption.dataset.vux || 0);
  const vuy = parseFloat(selectedOption.dataset.vuy || 0);
  const mux = parseFloat(selectedOption.dataset.mux || 0);
  const muy = parseFloat(selectedOption.dataset.muy || 0);
  
  // Apply to demand input fields
  const puField = document.getElementById('PuKips');
  const vuxField = document.getElementById('VuxKips');
  const vuyField = document.getElementById('VuyKips');
  const muxField = document.getElementById('MuxKipFt');
  const muyField = document.getElementById('MuyKipFt');
  
  if (puField) puField.value = pu.toFixed(1);
  if (vuxField) vuxField.value = vux.toFixed(1);
  if (vuyField) vuyField.value = vuy.toFixed(1);
  if (muxField) muxField.value = mux.toFixed(1);
  if (muyField) muyField.value = muy.toFixed(1);
  
  // Calculate flexural moment per foot for flexural design
  const { capLenX, capLenY } = getCapPlanDimsFt();
  const MuKipFt_x = mux / capLenY; // moment per foot in X-direction
  const MuKipFt_y = muy / capLenX; // moment per foot in Y-direction
  const governing_MuKipFt = Math.max(MuKipFt_x, MuKipFt_y);
  
  const flexField = document.getElementById('MuKipFt');
  if (flexField) flexField.value = governing_MuKipFt.toFixed(2);
  
  // Trigger recalculation
  calculateOneWayShear();
  calculateTwoWayShear();
  calculateFlexuralDesign();
  
  // Show success message
  const selectedName = selectedOption.textContent.split(' - ')[0];
  const statusMsg = `✅ Applied "${selectedName}" demands successfully!\n\nDemands:\n• Pu = ${pu.toFixed(1)} kips\n• Vux = ${vux.toFixed(1)} kips\n• Vuy = ${vuy.toFixed(1)} kips\n• Mux = ${mux.toFixed(1)} kip-ft\n• Muy = ${muy.toFixed(1)} kip-ft\n• Governing Mu/ft = ${governing_MuKipFt.toFixed(2)} kip-ft/ft`;
  
  alert(statusMsg);
  console.log('Applied load case:', selectedName, 'with demands:', {pu, vux, vuy, mux, muy, governing_MuKipFt});
}

// Auto-populate load cases when geometry changes
document.addEventListener('DOMContentLoaded', function() {
  // Populate load cases on page load
  populateLCPicker();
  
  // Re-populate when key geometry inputs change
  const geometryInputs = ['pile_no_x', 'pile_no_y', 'pile_spacing_x', 'pile_spacing_y', 'footing_thickness', 'pile_overhang'];
  geometryInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('change', function() {
        populateLCPicker();
        console.log('Load cases updated due to geometry change in:', id);
      });
    }
  });
  
  console.log('Load Case Picker system initialized');
});

// =====================================  
// Real LC Picker for Load Cases Table
// =====================================

function populateLCPicker() {
  const sel = document.getElementById('lcPicker');
  if (!sel) return;

  // Preserve current selection (if any)
  const prev = sel.value;

  sel.innerHTML = '';
  const warn = [];
  const seen = new Set();

  if (!Array.isArray(loadCasesData) || !loadCasesData.length) {
    sel.disabled = true;
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No load cases available';
    sel.appendChild(opt);
    return;
  }

  sel.disabled = false;

  loadCasesData.forEach(row => {
    // row expected: [LC, factor, Fx, Fy, Fz, Mx, My]
    const LC  = Number(row[0]);
    const Fx  = Number(row[2]);
    const Fy  = Number(row[3]);
    const Fz  = Number(row[4]);
    const Mx  = Number(row[5]);
    const My  = Number(row[6]);

    if (seen.has(LC)) warn.push(LC);
    seen.add(LC);

    const opt = document.createElement('option');
    opt.value = String(LC);
    opt.textContent = `LC ${LC}  |  Fx ${Fx} k  Fy ${Fy} k  Fz ${Fz} k  Mx ${Mx} k-ft  My ${My} k-ft`;
    sel.appendChild(opt);
  });

  // Try to restore previous selection
  if (prev && [...sel.options].some(o => o.value === prev)) {
    sel.value = prev;
  }

  // Show a gentle warning in the lcPicker note if duplicates exist
  const note = document.getElementById('lcPickerNote');
  if (note) {
    if (warn.length) {
      note.innerHTML = `⚠️ Duplicate Load Case IDs detected: <b>${[...new Set(warn)].join(', ')}</b>. ` +
                       `Using the first matching row. Consider making IDs unique.`;
    } else if (!note.innerHTML.includes('Using')) {
      // leave any mapping note we wrote earlier; otherwise clear
      note.textContent = '';
    }
  }
}

function applyDemandsFromLC() {
  const sel = document.getElementById('lcPicker');
  const dir = (document.getElementById('stripDir')?.value || 'X').toUpperCase();
  const noteEl = document.getElementById('lcPickerNote');

  if (!sel || !sel.value) { alert('Select a Load Case first.'); return; }

  // LC id as number (handles "1", "1.0", "01")
  const LCid = Number(sel.value);

  // Find the FIRST matching LC row
  const row = loadCasesData.find(r => Number(r[0]) === LCid);
  if (!row) {
    alert(`Selected Load Case ${sel.value} not found in table.`);
    return;
  }

  const [, factor, Fx, Fy, Fz, Mx, My] = row.map(Number);

  const { capLenX, capLenY, overhang_ft } = getCapPlanDimsFt();
  // update labels
  const lenXEl = document.getElementById('capLenXLabel');
  const lenYEl = document.getElementById('capLenYLabel');
  const ohEl   = document.getElementById('capOverhangLabel');
  if (lenXEl) lenXEl.textContent = `${capLenX.toFixed(2)} ft`;
  if (lenYEl) lenYEl.textContent = `${capLenY.toFixed(2)} ft`;
  if (ohEl)   ohEl.textContent   = `${(overhang_ft*12).toFixed(1)} in`;

  // Demand mapping (documented in the note)
  const Vu_punch = Math.abs(Fz);
  const Vu_oneway_perft = (dir === 'X')
    ? Math.abs(Fz) / Math.max(capLenY, 1e-6)
    : Math.abs(Fz) / Math.max(capLenX, 1e-6);

  const Mu_kipft = (dir === 'X')
    ? Math.abs(My) / Math.max(capLenY, 1e-6)
    : Math.abs(Mx) / Math.max(capLenX, 1e-6);

  // Apply to inputs
  const vu1 = document.getElementById('VuOneWayPerFt');
  const vup = document.getElementById('VuPunchKips');
  const mu  = document.getElementById('MuKipFt');
  if (vu1) vu1.value = Vu_oneway_perft.toFixed(2);
  if (vup) vup.value = Vu_punch.toFixed(1);
  if (mu)  mu.value  = Mu_kipft.toFixed(1);

  // Friendly mapping note
  if (noteEl) {
    const mTxt = (dir === 'X') ? `Mᵤ per-ft = |My| / cap width (Y)` : `Mᵤ per-ft = |Mx| / cap width (X)`;
    const vTxt = (dir === 'X') ? `Vᵤ per-ft = |Fz| / cap width (Y)` : `Vᵤ per-ft = |Fz| / cap width (X)`;
    noteEl.innerHTML = `
      Using <b>LC ${LCid}</b>, strip <b>${dir}</b>.<br>
      ${vTxt}. Punching Vᵤ = |Fz|. ${mTxt}.<br>
      Cap dims: X=${capLenX.toFixed(2)} ft, Y=${capLenY.toFixed(2)} ft.
    `;
  }

  // Re-run checks so results reflect the pulled demands
  calculateOneWayShear();
  calculateTwoWayShear();
  calculateFlexuralDesign();
}

// =====================================
// One-Way Shear Slicer Functions
// =====================================

// Canvas mapping cache from your pile-force visualization
function getCanvasMap() {
  const canvas = document.getElementById('forceCanvas');
  if (!canvas || !pileCoordinates.length) return null;

  // Rebuild same transforms used in drawPileForceVisualization()
  const xCoords = pileCoordinates.map(p => p.x);
  const yCoords = pileCoordinates.map(p => p.y);
  const minX = Math.min(...xCoords), maxX = Math.max(...xCoords);
  const minY = Math.min(...yCoords), maxY = Math.max(...yCoords);
  const margin = 50;
  const drawWidth = canvas.width - 2*margin;
  const drawHeight = canvas.height - 2*margin;
  const xRange = (maxX - minX) || 1;
  const yRange = (maxY - minY) || 1;
  const scale = Math.min(drawWidth / xRange, drawHeight / yRange) * 0.8;
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const midX = (minX + maxX) / 2;
  const midY = (minY + maxY) / 2;

  // world(ft) -> canvas(px)
  function WtoC(x_ft, y_ft) {
    const x = centerX + (x_ft - midX) * scale;
    const y = centerY - (y_ft - midY) * scale; // flip Y
    return { x, y };
  }
  return { canvas, WtoC, scale, minX, maxX, minY, maxY };
}

// Compute dv (in), column faces, and cut position (ft)
function getCutLocation() {
  const { d_in, dv_in, cx_in, cy_in } = getDesignParams();
  const dir   = (document.getElementById('sliceDir')?.value || 'X').toUpperCase();
  const side  = (document.getElementById('sliceSide')?.value || '+');
  const offs_in = parseFloat(document.getElementById('sliceOffset')?.value || 0);

  // Column is centered at (0,0); faces at ±cx/2 and ±cy/2 (in); convert to ft
  const faceX_ft_pos = (cx_in/2) / 12.0;
  const faceX_ft_neg = -(cx_in/2) / 12.0;
  const faceY_ft_pos = (cy_in/2) / 12.0;
  const faceY_ft_neg = -(cy_in/2) / 12.0;

  // Section is at dv from face + offset (on selected side)
  const dv_ft = dv_in / 12.0;
  const offs_ft = offs_in / 12.0;

  let cutCoord_ft; // x=const (for X dir) or y=const (for Y dir)
  if (dir === 'X') {
    // section is parallel to Y, so x = constant
    cutCoord_ft = (side === '+')
      ? (faceX_ft_pos + dv_ft + offs_ft)
      : (faceX_ft_neg - dv_ft - offs_ft);
  } else {
    // dir === 'Y' -> section parallel to X, so y = constant
    cutCoord_ft = (side === '+')
      ? (faceY_ft_pos + dv_ft + offs_ft)
      : (faceY_ft_neg - dv_ft - offs_ft);
  }
  return { dir, side, cutCoord_ft, dv_in };
}

// === PATCH: support "average both sides" in the slice calc ===
function computeVuFromSlice() {
  const lcSel = document.getElementById('sliceLC');
  if (!lcSel || !lcSel.value) { alert('Select a Load Case for the slicer.'); return null; }
  const LCid = parseFloat(lcSel.value);

  if (!analysisResultsData || !analysisResultsData[LCid]) {
    alert('No analysis data for the selected Load Case. Run Step 3 analysis first.');
    return null;
  }

  const { dir, side, cutCoord_ft, dv_in } = getCutLocation();
  const forces = analysisResultsData[LCid]; // kips per pile
  const avgBoth = !!document.getElementById('avgBothSides')?.checked;

  // Helper to sum a side
  const sumSide = (sgn) => {
    let sum = 0;
    pileCoordinates.forEach((p, idx) => {
      const onSide = (dir === 'X')
        ? ((sgn === '+') ? (p.x >= cutCoord_ft) : (p.x <= cutCoord_ft))
        : ((sgn === '+') ? (p.y >= cutCoord_ft) : (p.y <= cutCoord_ft));
      if (onSide) sum += (forces[idx] || 0);
    });
    return Math.abs(sum);
  };

  let Vu_kips = 0;
  if (avgBoth) {
    // average absolute shear from both sides at the same cut
    const Vu_pos = sumSide('+');
    const Vu_neg = sumSide('-');
    Vu_kips = 0.5 * (Vu_pos + Vu_neg);
  } else {
    Vu_kips = sumSide(side); // only chosen side
  }

  // Section length is the span parallel to the section line
  const { capLenX, capLenY } = getCapPlanDimsFt();
  const sectionLen_ft = (dir === 'X') ? capLenY : capLenX;
  const Vu_perft = Vu_kips / Math.max(sectionLen_ft, 1e-6);

  return { Vu_kips, Vu_perft, sectionLen_ft, dir, cutCoord_ft, dv_in };
}

// === PATCH: drawSliceOverlay now assumes base was just refreshed ===
function drawSliceOverlay(result) {
  const map = getCanvasMap();
  if (!map) return;
  const { canvas, WtoC, minX, maxX, minY, maxY } = map;
  const ctx = canvas.getContext('2d');

  ctx.save();
  ctx.lineWidth = 3;
  ctx.setLineDash([10, 6]);
  ctx.strokeStyle = '#e74c3c';

  if (result.dir === 'X') {
    const p1 = WtoC(result.cutCoord_ft, minY - 1);
    const p2 = WtoC(result.cutCoord_ft, maxY + 1);
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
  } else {
    const p1 = WtoC(minX - 1, result.cutCoord_ft);
    const p2 = WtoC(maxX + 1, result.cutCoord_ft);
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
  }

  // Glow contributing piles per the current side selection
  const sideSel = document.getElementById('sliceSide')?.value || '+';
  ctx.lineWidth = 2;
  pileCoordinates.forEach((p) => {
    const onSide = (result.dir === 'X')
      ? ((sideSel === '+') ? (p.x >= result.cutCoord_ft) : (p.x <= result.cutCoord_ft))
      : ((sideSel === '+') ? (p.y >= result.cutCoord_ft) : (p.y <= result.cutCoord_ft));
    if (onSide && p._drawX && p._drawY) {
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(231,76,60,0.95)';
      ctx.fillStyle = 'rgba(231,76,60,0.15)';
      const r = (p._radius || 14) + 4;
      ctx.arc(p._drawX, p._drawY, r, 0, 2 * Math.PI);
      ctx.fill(); ctx.stroke();
    }
  });

  ctx.restore();
}

// Push the slicer result into One-Way demand input and recompute
function pushSliceToDemand(res) {
  const vuBox = document.getElementById('VuOneWayPerFt');
  if (vuBox) {
    vuBox.value = res.Vu_perft.toFixed(2);
    // Recompute one-way immediately
    calculateOneWayShear();
  }
}

// Populate slicer LC select from current loadCasesData
function populateSliceLC() {
  const sel = document.getElementById('sliceLC');
  if (!sel) return;
  sel.innerHTML = '';
  if (!loadCasesData || !loadCasesData.length) {
    sel.disabled = true;
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No load cases available';
    sel.appendChild(opt);
    return;
  }
  sel.disabled = false;
  loadCasesData.forEach(row => {
    const [LC, , Fx, Fy, Fz, Mx, My] = row;
    const opt = document.createElement('option');
    opt.value = LC;
    opt.textContent = `LC ${LC}  |  Fz ${Fz} k, Mx ${Mx} k-ft, My ${My} k-ft`;
    sel.appendChild(opt);
  });
}

// === ENHANCED: Handle compute button with fresh view and averaging support ===
function handleSliceCompute() {
  const res = computeVuFromSlice();
  if (!res) return;

  // Update readouts (same as before)
  const where = document.getElementById('sliceWhere');
  const vuK   = document.getElementById('sliceVuK');
  const lenFt = document.getElementById('sliceLenFt');
  const vuPFt = document.getElementById('sliceVuPerFt');
  const note  = document.getElementById('sliceNote');

  if (where) where.textContent = (res.dir === 'X')
    ? `x = ${res.cutCoord_ft.toFixed(2)} ft (at dᵥ=${res.dv_in.toFixed(1)} in from face ± offset)`
    : `y = ${res.cutCoord_ft.toFixed(2)} ft (at dᵥ=${res.dv_in.toFixed(1)} in from face ± offset)`;
  if (vuK)   vuK.textContent   = res.Vu_kips.toFixed(1);
  if (lenFt) lenFt.textContent = res.sectionLen_ft.toFixed(2);
  if (vuPFt) vuPFt.textContent = res.Vu_perft.toFixed(2);

  const side = (document.getElementById('avgBothSides')?.checked) ? 'average of + and − sides' : `side ${(document.getElementById('sliceSide')?.value || '+')}`;
  if (note) note.innerHTML = `Using pile reactions from selected LC; contribution = <b>${side}</b>.`;

  // 🔁 Fresh base → optional column → overlay
  refreshSliceView(res);
}

// === NEW: draw the column outline on the forceCanvas ===
function drawColumnOutline() {
  const map = getCanvasMap();
  if (!map) return;
  const { canvas, WtoC } = map;
  const ctx = canvas.getContext('2d');

  const { cx_in, cy_in } = getDesignParams();
  const hx_ft = (cx_in/12) / 2; // half-width in ft
  const hy_ft = (cy_in/12) / 2;

  const p1 = WtoC(-hx_ft, -hy_ft);
  const p2 = WtoC( hx_ft, -hy_ft);
  const p3 = WtoC( hx_ft,  hy_ft);
  const p4 = WtoC(-hx_ft,  hy_ft);

  ctx.save();
  ctx.lineWidth = 3;
  ctx.strokeStyle = 'rgba(231,76,60,0.95)';   // bold edge
  ctx.fillStyle   = 'rgba(231,76,60,0.12)';   // soft fill
  ctx.beginPath();
  ctx.moveTo(p1.x, p1.y);
  ctx.lineTo(p2.x, p2.y);
  ctx.lineTo(p3.x, p3.y);
  ctx.lineTo(p4.x, p4.y);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

// === NEW: refresh base drawing, optional column, then overlay ===
function refreshSliceView(result) {
  // Redraw the base pile visualization so overlays don't accumulate
  drawPileForceVisualization();

  // Optionally draw the column outline
  const showCol = !!document.getElementById('showColumnOutline')?.checked;
  if (showCol) drawColumnOutline();

  // Then draw the slice overlay (line + contributing pile halos)
  drawSliceOverlay(result);
}

// === ENHANCED: Handle push to demand with visual confirmation ===
function handleSlicePush() {
  const res = computeVuFromSlice();
  if (!res) return;
  pushSliceToDemand(res);
  // optional: visually confirm by flashing the input
  const vuBox = document.getElementById('VuOneWayPerFt');
  if (vuBox) { vuBox.style.boxShadow = '0 0 0 3px rgba(46,204,113,.4)'; setTimeout(()=>vuBox.style.boxShadow='none', 500); }
}
</script>
</body>
</html>
